<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <title>Lab2A&amp;2B-Raft-leaderé€‰ä¸¾ä¸æ—¥å¿—åŒæ­¥-å®ç°è¿‡ç¨‹ | å°è´ºçš„åšå®¢</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="Raft å®ç°çœŸçš„æ¯”è¾ƒéš¾ï¼Œé¦–å…ˆè¦ä»æ•´ä½“ä¸Šå®Œå…¨ç†è§£ Raft çš„è¿è¡Œæœºåˆ¶å°±æ¯”è¾ƒå›°éš¾ã€‚å†å…·ä½“åˆ°å®ç°ä¸Šï¼Œæ¶‰åŠåˆ°å¾ˆå¤šä¸ªåå° goroutineï¼ˆgoroutine ä¸­èµ· goroutineï¼‰ï¼Œå¦‚ä½•åŠ é”æ‰èƒ½å®‰å…¨è¯»å–å†™å…¥å…±äº«å˜é‡ï¼ˆä¸€ä¸å°å¿ƒè¿˜æ­»é”ï¼‰ï¼Œå¹¶å‘éš¾ä»¥ debugï¼Œè®¡æ—¶å™¨çš„å®ç°&hellip; è¿™ç¯‡æ–‡ç« è®°å½•ä¸‹æˆ‘çš„ä¸ªäººç»éªŒæŠŠï¼Œå¸Œæœ›å¯¹å…¶ä»–äººèƒ½æœ‰æ‰€å¸®åŠ©
 å®éªŒå‰ ğŸ”—å¿…çœ‹ ğŸ”—  raftè®ºæ–‡ leader é€‰ä¸¾å’Œ Log å¤åˆ¶éƒ¨åˆ†
  Lab2-å®éªŒæ–‡æ¡£-Raft-ç¿»è¯‘Lab2-å®éªŒæ–‡æ¡£-Raft-ç¿»è¯‘ 2A 2B
  Lecture-06-ç¬”è®°-Raft(1)-ç¿»è¯‘ Lecture-07-ç¬”è®°-Raft(2)-ç¿»è¯‘
  é€‰çœ‹ ğŸ”— lec 3,4 è¯¾ç¨‹è§†é¢‘ lec 6, 7  å»ºè®® ğŸ”—  lecture 3 è®² GFSï¼Œlecture 4 è®²ä¸€ä¸ªå¤åˆ¶å®¹é”™çš„è®ºæ–‡ã€‚ä¸æˆ‘ä»¬è¦å®ç°çš„ raft çš„å…³ç³»ä¸å¤§ï¼Œæœ€å¤šç®—ä¸€äº›å‰ç½®çŸ¥è¯†ï¼Œå»ºè®®ä¸çœ‹ã€‚
  å»ºè®® lab2A ä¸ lab2B ä¸€èµ·åšï¼Œè™½ç„¶ lab2 æ–‡æ¡£æŠŠ lab åˆ†å¼€ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚ä½†æ˜¯æˆ‘ä»¬æ˜¯å»å¯¹ç…§è®ºæ–‡å®ç°ï¼Œå°¤å…¶åœ¨ RequestVote ä¸ AppendEnties ä¸¤ä¸ª RPC ä¸­ï¼Œè¿™ä¸¤è€…æ··æ‚åœ¨ä¸€èµ·
  å¤šè¯»å‡ éè®ºæ–‡ä¸ lab2 æ–‡æ¡£ï¼Œå°¤å…¶æ˜¯è®ºæ–‡ä¸­çš„å›¾ 2, å†å¼€å§‹ lab&hellip;">
<meta name="generator" content="Hugo 0.93.3" />


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/xiaohe-blog/css/style.css">



<link rel="shortcut icon" href="/xiaohe-blog/images/favicon.ico" type="image/x-icon" />

 
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-FY1WNXTY3L', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







  </head>

  <body>
    <nav class="navigation">
	
		<a href="/xiaohe-blog/"> <span class="arrow">â†</span>é¦–é¡µ</a>
	
	<a href="/xiaohe-blog/posts">å½’æ¡£</a>
	<a href="/xiaohe-blog/tags">æ ‡ç­¾</a>
	<a href="/xiaohe-blog/about">å…³äº</a>

	
		<a href="/xiaohe-blog/algorithm">ç®—æ³•</a>
	
		<a href="/xiaohe-blog/mixed">æ‚è°ˆ</a>
	
		<a href="/xiaohe-blog/reading">è¯»ä¹¦</a>
	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">Lab2A&amp;2B-Raft-leaderé€‰ä¸¾ä¸æ—¥å¿—åŒæ­¥-å®ç°è¿‡ç¨‹</h1>

    <div class="tip">
        <time datetime="2021-12-28 14:30:00 &#43;0800 CST">2021å¹´12æœˆ28æ—¥</time>
        <span class="split">
          Â·
        </span>
        <span>
          2231å­—
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          11åˆ†é’Ÿ
        </span>
    </div>

    
    


    <div class="content">
      <blockquote>
<p>Raft å®ç°çœŸçš„æ¯”è¾ƒéš¾ï¼Œé¦–å…ˆè¦ä»æ•´ä½“ä¸Šå®Œå…¨ç†è§£ Raft çš„è¿è¡Œæœºåˆ¶å°±æ¯”è¾ƒå›°éš¾ã€‚å†å…·ä½“åˆ°å®ç°ä¸Šï¼Œæ¶‰åŠåˆ°å¾ˆå¤šä¸ªåå° goroutineï¼ˆgoroutine ä¸­èµ· goroutineï¼‰ï¼Œå¦‚ä½•åŠ é”æ‰èƒ½å®‰å…¨è¯»å–å†™å…¥å…±äº«å˜é‡ï¼ˆä¸€ä¸å°å¿ƒè¿˜æ­»é”ï¼‰ï¼Œå¹¶å‘éš¾ä»¥ debugï¼Œè®¡æ—¶å™¨çš„å®ç°&hellip; è¿™ç¯‡æ–‡ç« è®°å½•ä¸‹æˆ‘çš„ä¸ªäººç»éªŒæŠŠï¼Œå¸Œæœ›å¯¹å…¶ä»–äººèƒ½æœ‰æ‰€å¸®åŠ©</p>
</blockquote>
<h2 id="å®éªŒå‰">å®éªŒå‰ <a href="#%e5%ae%9e%e9%aa%8c%e5%89%8d" class="anchor">ğŸ”—</a></h2><h3 id="å¿…çœ‹">å¿…çœ‹ <a href="#%e5%bf%85%e7%9c%8b" class="anchor">ğŸ”—</a></h3><ul>
<li>
<p><a href="https://raft.github.io/raft.pdf" target="_blank" rel="noopener">raftè®ºæ–‡</a> leader é€‰ä¸¾å’Œ Log å¤åˆ¶éƒ¨åˆ†</p>
</li>
<li>
<p><a href="https://github.com/he2121/MIT6.824-2021/blob/main/docs-cn/lab-02.md" target="_blank" rel="noopener">Lab2-å®éªŒæ–‡æ¡£-Raft-ç¿»è¯‘</a><a href="https://github.com/he2121/MIT6.824-2021/blob/main/docs-cn/lab-02.md" target="_blank" rel="noopener">Lab2-å®éªŒæ–‡æ¡£-Raft-ç¿»è¯‘</a> 2A 2B</p>
</li>
<li>
<p><a href="https://github.com/he2121/MIT6.824-2021/blob/main/docs-cn/lect-note-06.md" target="_blank" rel="noopener">Lecture-06-ç¬”è®°-Raft(1)-ç¿»è¯‘</a>   <a href="https://github.com/he2121/MIT6.824-2021/blob/main/docs-cn/lect-note-07.md" target="_blank" rel="noopener">Lecture-07-ç¬”è®°-Raft(2)-ç¿»è¯‘</a></p>
</li>
</ul>
<h3 id="é€‰çœ‹">é€‰çœ‹ <a href="#%e9%80%89%e7%9c%8b" class="anchor">ğŸ”—</a></h3><ul>
<li>lec 3,4</li>
<li><a href="https://www.bilibili.com/video/BV1R7411t71W?p=6" target="_blank" rel="noopener">è¯¾ç¨‹è§†é¢‘ lec 6, 7</a></li>
</ul>
<h3 id="å»ºè®®">å»ºè®® <a href="#%e5%bb%ba%e8%ae%ae" class="anchor">ğŸ”—</a></h3><ul>
<li>
<p>lecture 3 è®² GFSï¼Œlecture 4 è®²ä¸€ä¸ªå¤åˆ¶å®¹é”™çš„è®ºæ–‡ã€‚ä¸æˆ‘ä»¬è¦å®ç°çš„ raft çš„å…³ç³»ä¸å¤§ï¼Œæœ€å¤šç®—ä¸€äº›å‰ç½®çŸ¥è¯†ï¼Œå»ºè®®ä¸çœ‹ã€‚</p>
</li>
<li>
<p>å»ºè®® lab2A ä¸ lab2B ä¸€èµ·åšï¼Œè™½ç„¶ lab2 æ–‡æ¡£æŠŠ lab åˆ†å¼€ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚ä½†æ˜¯æˆ‘ä»¬æ˜¯å»å¯¹ç…§è®ºæ–‡å®ç°ï¼Œå°¤å…¶åœ¨ <code>RequestVote</code> ä¸ <code>AppendEnties</code> ä¸¤ä¸ª RPC ä¸­ï¼Œè¿™ä¸¤è€…æ··æ‚åœ¨ä¸€èµ·</p>
</li>
<li>
<p>å¤šè¯»å‡ éè®ºæ–‡ä¸ lab2 æ–‡æ¡£ï¼Œå°¤å…¶æ˜¯è®ºæ–‡ä¸­çš„å›¾ 2, å†å¼€å§‹ lab&hellip;</p>
</li>
<li>
<p>è®ºæ–‡æš‚æ—¶å¯ä»¥åªé˜…è¯»ä¸ 2a 2b ç›¸å…³çš„éƒ¨åˆ†</p>
</li>
</ul>
<h2 id="å®éªŒè¿‡ç¨‹">å®éªŒè¿‡ç¨‹ <a href="#%e5%ae%9e%e9%aa%8c%e8%bf%87%e7%a8%8b" class="anchor">ğŸ”—</a></h2><h3 id="æ€è·¯åˆ†æ">æ€è·¯åˆ†æ <a href="#%e6%80%9d%e8%b7%af%e5%88%86%e6%9e%90" class="anchor">ğŸ”—</a></h3><p>è®ºæ–‡ä¸­çš„è¿™å›¾å¤ªé‡è¦äº†ï¼Œæ”¾ä¸Šæ¥å†çœ‹ä¸€ä¸‹å§</p>
<p><p class="markdown-image">
  <img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20211229170522923-2021-12-29.png" alt="image-20211229170522923"  />
</p></p>
<p>åœ¨ 2aï¼Œ2c å®éªŒä¸­ï¼Œæˆ‘ä»¬è®¤ä¸ºï¼š</p>
<ul>
<li>æ‰€æœ‰æ—¥å¿—éƒ½å­˜åœ¨äºå†…å­˜ä¸­ï¼ŒæŒä¹…åŒ–åœ¨ 2c è€ƒè™‘</li>
<li>ä¸ä¸Šå±‚åº”ç”¨äº¤äº’çš„é€»è¾‘åº”è¯¥æ˜¯è¿™ä¸ªå®éªŒæœ€åè€ƒè™‘çš„åœ°æ–¹ï¼Œæˆ‘ä»¬å…ˆè€ƒè™‘å®ç° leader é€‰ä¸¾ï¼Œå‘é€å¿ƒè·³çš„é€»è¾‘</li>
</ul>
<h4 id="ä¸‰ç§è§’è‰²">ä¸‰ç§è§’è‰² <a href="#%e4%b8%89%e7%a7%8d%e8%a7%92%e8%89%b2" class="anchor">ğŸ”—</a></h4><h5 id="å­—æ®µæ„ä¹‰">å­—æ®µæ„ä¹‰ <a href="#%e5%ad%97%e6%ae%b5%e6%84%8f%e4%b9%89" class="anchor">ğŸ”—</a></h5><p>æŒ‰ç…§è®ºæ–‡æè¿°å’Œæˆ‘çš„å®é™…å®ç°ï¼Œæˆ‘åœ¨ Raft å®ä¾‹ä¸­å¢åŠ äº†ä»¥ä¸‹å­—æ®µã€‚</p>
<p>è¿™äº›å­—æ®µå¤§å¤šæ•°éƒ½ä¼šè¢«å¹¶å‘è¯»å†™ï¼Œè¯·åœ¨è®¿é—®å‰ååŠ é”</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// A Go object implementing a single Raft peer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Raft</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mu</span>        <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>          <span style="color:#75715e">// Lock to protect shared access to this peer&#39;s state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">peers</span>     []<span style="color:#f92672">*</span><span style="color:#a6e22e">labrpc</span>.<span style="color:#a6e22e">ClientEnd</span> <span style="color:#75715e">// RPC end points of all peers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">persister</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Persister</span>          <span style="color:#75715e">// Object to hold this peer&#39;s persisted state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">me</span>        <span style="color:#66d9ef">int</span>                 <span style="color:#75715e">// this peer&#39;s index into peers[]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">dead</span>      <span style="color:#66d9ef">int32</span>               <span style="color:#75715e">// set by Kill()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Your data here (2A, 2B, 2C).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Look at the paper&#39;s Figure 2 for a description of what
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// state a Raft server must maintain.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">state</span> <span style="color:#a6e22e">State</span>            <span style="color:#75715e">// æ­¤å®ä¾‹çŠ¶æ€: Follower, Candidate, Leader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">currentTerm</span> <span style="color:#66d9ef">int</span>        <span style="color:#75715e">// å½“å‰ä»»æœŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">voteFor</span> <span style="color:#66d9ef">int</span>            <span style="color:#75715e">// å½“å‰ä»»æœŸæŠ•ç¥¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">logs</span> []<span style="color:#a6e22e">LogEntry</span>        <span style="color:#75715e">// æ‰€æœ‰æ—¥å¿—æ¡ç›®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">commitIndex</span> <span style="color:#66d9ef">int</span>        <span style="color:#75715e">// for 2b,å·²ç»æäº¤çš„æœ€æ–°æ—¥å¿—çš„ index, &#34;å·²ç»æäº¤&#34; == è¿™æ¡æ—¥å¿—å·²ç»è¢«å¤§å¤šæ•° server æ‰€æ¥å—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">lastApplied</span> <span style="color:#66d9ef">int</span>        <span style="color:#75715e">// for 2b, å·²åº”ç”¨åˆ°çš„ä¸Šå±‚åº”ç”¨æ—¥å¿—æœ€æ–°çš„ indexï¼Œåå°å®šæ—¶æ ¹æ® commitIndex çš„å¢åŠ å»æäº¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">applyCh</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">ApplyMsg</span>    <span style="color:#75715e">// for 2b, éœ€è¦æŠŠå·²ç» committed çš„ log apply åˆ° ä¸Šå±‚åº”ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// for leader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">nextIndex</span> []<span style="color:#66d9ef">int</span>        <span style="color:#75715e">// è®°å½•å„ä¸ª Server å†™å…¥æ–° Log çš„ä½ç½® indexï¼ˆæ„å‘³ç€è¿™ä¸ªä½ç½®ä»¥å‰çš„æ—¥å¿—åœ¨ leader ä¸ follower å®Œå…¨ä¸€è‡´ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">matchIndex</span> []<span style="color:#66d9ef">int</span>    <span style="color:#75715e">// å„ä¸ª Server å·²æœ‰ Log çš„ä¸ leader ä¿æŒä¸€è‡´æœ€åçš„ä½ç½® = nextIndex - 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">electionTimeout</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>     <span style="color:#75715e">// åº”è¯¥è¢«ä¸æ–­ resetï¼Œå§‹ç»ˆæ¯” time.Now() å°ã€‚ä½†å¦‚æœåˆ°ç‚¹äº†ï¼Œè¯´æ˜è¿‡æœŸäº†ï¼Œå‘èµ·é€‰ä¸¾
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">State</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Follower</span> <span style="color:#a6e22e">State</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Candidate</span> <span style="color:#a6e22e">State</span> = <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Leader</span> <span style="color:#a6e22e">State</span> = <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">LogEntry</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Command</span> <span style="color:#66d9ef">interface</span>{}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Term</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>çŠ¶æ€æµè½¬å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆè®ºæ–‡å›¾ 4ï¼‰ï¼Œ<strong>ç‰¢è®°</strong>ï¼ŒæŒ‰ç…§è¿™ä¸ªé¡ºåºå»ä¸€ä¸€å®ç°ä»£ç é€»è¾‘</p>
<p><p class="markdown-image">
  <img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20211229172959678-2021-12-29.png" alt="image-20211229172959678"  />
</p></p>
<p>å„ä¸ªè§’è‰²<strong>åå°</strong>æ‰€éœ€è¦ä¸€ç›´<strong>è¿è¡Œçš„ä»»åŠ¡</strong>å§</p>
<h5 id="follower--candidate--leader">Follower &amp; Candidate &amp; leader: <a href="#follower--candidate--leader" class="anchor">ğŸ”—</a></h5><ul>
<li><strong>æ£€æµ‹é€‰ä¸¾è¶…æ—¶</strong>ï¼Œå¦‚æœè¶…æ—¶ï¼Œéœ€è¦å‘èµ·é€‰ä¸¾ã€‚leader ä¸éœ€è¦æ£€æµ‹ï¼Œä½†æ˜¯éœ€è¦ä¿æŒè¿™ä¸ªåå°ä»»åŠ¡ï¼Œå› ä¸º leader å¯ä»¥è½¬å˜æˆå…¶å®ƒçŠ¶æ€</li>
<li><strong>åº”ç”¨ log åˆ°ä¸Šå±‚åº”ç”¨</strong>ï¼ŒcommitIndex &gt; appliedIndex, åˆ™éœ€è¦æŠŠ [appliedIndex + 1, committedIndex] çš„ logï¼Œåº”ç”¨åˆ°ä¸Šå±‚åº”ç”¨ï¼Œfor 2b</li>
</ul>
<h5 id="leader">Leader: <a href="#leader" class="anchor">ğŸ”—</a></h5><ul>
<li><strong>å®šæ—¶å‘é€æ—¥å¿—å¤åˆ¶è¯·æ±‚(å¿ƒè·³æ˜¯å…¶ä¸€ä¸ªç‰¹ä¾‹)</strong>ï¼Œé˜²æ­¢å…¶å®ƒ server å‘èµ·é€‰ä¸¾ï¼ˆå…¶å®ƒ server æ”¶åˆ°è¯·æ±‚ï¼Œ é‡ç½®é€‰ä¸¾æ—¶é—´ï¼‰</li>
<li><strong>æ›´æ–° leader çš„ commitIndex</strong>ï¼Œè¿™é‡Œéœ€è¦æ£€æµ‹æ–° log æ˜¯å¦å¤åˆ¶åˆ°å¤§å¤šæ•°æœºå™¨ä¸Šäº†ï¼Œfor 2b</li>
</ul>
<h4 id="ä¸¤ç§-rpc">ä¸¤ç§ RPC <a href="#%e4%b8%a4%e7%a7%8d-rpc" class="anchor">ğŸ”—</a></h4><p>Raft å°±ä¸¤ä¸ª RPCï¼Œè¿™é‡Œç®€å•è¯´æ˜ä¸‹å®ƒä»¬æ˜¯å¹²ä»€ä¹ˆçš„</p>
<h5 id="requestvote"><code>RequestVote</code> <a href="#requestvote" class="anchor">ğŸ”—</a></h5><ul>
<li>
<p>è§¦å‘è¯·æ±‚çš„æ—¶æœº:</p>
<ul>
<li>é€‰ä¸¾è¶…æ—¶ (follower/candidate åœ¨ä¸€æ®µæ—¶é—´æ²¡æ”¶åˆ° leader çš„å¿ƒè·³äº†)</li>
</ul>
</li>
<li>
<p>æ¥æ”¶åˆ°è¯·æ±‚ï¼Œserver ç«¯çš„é€»è¾‘</p>
<ol>
<li>æ‹’ç» term æ¯”è‡ªå·±å°çš„è¯·æ±‚</li>
<li>æ”¶åˆ° term æ¯”è‡ªå·±å¤§çš„è¯·æ±‚ï¼Œæ›´æ–°termï¼Œè½¬æˆ Followerï¼Œå†å¾€ä¸‹å¤„ç†</li>
<li>åˆ¤æ–­è¯¥ä¸è¯¥ç»™è¿™ä¸ªè¯·æ±‚æŠ•ç¥¨
<ol>
<li>è‡ªå·±åœ¨è¿™ä¸€è½®ï¼Œè¿˜æ²¡æœ‰æŠ•è¿‡ç¥¨</li>
<li>åªç»™å¯¹æ–¹æ—¥å¿—é¢†å…ˆï¼ˆåŒ…æ‹¬ä¸€è‡´ï¼‰è‡ªå·±æ—¥å¿—çš„æŠ•ç¥¨ï¼ˆè¿™æ ·æ‰èƒ½é€‰å‡ºåŒ…æ‹¬ commited æ—¥å¿—çš„ Leaderï¼‰</li>
</ol>
</li>
</ol>
</li>
<li>
<p>æ”¶åˆ°å›å¤åï¼Œclient é€»è¾‘</p>
<ol>
<li>
<p>å¦‚æœ reply çš„ term æ¯”è‡ªå·± term å¤§ï¼Œæ›´æ–°termï¼Œè½¬æˆ Followerï¼Œç›´æ¥è¿”å›</p>
</li>
<li>
<p>å¦‚æœ reply æŠ•ç¥¨æˆåŠŸï¼ŒnumVote ++</p>
</li>
<li>
<p>numVote å¤§äºä¸€åŠçš„æœåŠ¡æ•°ï¼Œå½“é€‰æˆ leader</p>
</li>
</ol>
</li>
</ul>
<h5 id="appendentries"><code>AppendEntries</code> <a href="#appendentries" class="anchor">ğŸ”—</a></h5><ul>
<li>è§¦å‘è¯·æ±‚çš„æ—¶æœº
<ul>
<li>å®šæ—¶å‘é€ï¼ˆåªæœ‰ Leader å‘é€ï¼‰</li>
</ul>
</li>
<li>æ¥æ”¶åˆ°è¯·æ±‚ï¼Œserver ç«¯çš„é€»è¾‘
<ol>
<li>æ‹’ç» term æ¯”è‡ªå·±å°çš„è¯·æ±‚</li>
<li>æ”¶åˆ° term æ¯”è‡ªå·±å¤§çš„è¯·æ±‚ï¼Œæ›´æ–°termï¼Œè½¬æˆ Followerï¼Œå†å¾€ä¸‹å¤„ç†</li>
<li>é‡ç½®é€‰ä¸¾æ—¶é—´</li>
<li>å¯¹æ¯”è‡ªå·±çš„ Log ä¸ args å‘è¿‡æ¥ prevLog
<ol>
<li>å¦‚æœè‡ªå·±çš„ log æ•°é‡å°‘äº prevLogIndexï¼Œè¿”å› FALSE</li>
<li>æˆ–è€…åœ¨åŒä¸€ä½ç½® Index æœ‰æ—¥å¿—ï¼Œä½† term ä¸ä¸€è‡´ï¼Œè¿”å› FALSE</li>
</ol>
</li>
<li>æˆªå–æ‰æ¯” prevLog å¤šçš„ Log</li>
<li>append æ–°çš„ Log</li>
<li>æ ¹æ® leader å‘è¿‡æ¥çš„ CommitIndex ä¸ è‡ªå·±çš„ LastIndex æ›´æ–°è‡ªå·±çš„ commitIndex</li>
</ol>
</li>
<li>æ”¶åˆ°å›å¤ï¼Œclient é€»è¾‘
<ol>
<li>å¦‚æœ reply çš„ term æ¯”è‡ªå·± term å¤§ï¼Œæ›´æ–°termï¼Œè½¬æˆ Followerï¼Œç›´æ¥è¿”å›</li>
<li>å¦‚æœæ”¶åˆ°è¯´æ˜å¤åˆ¶æˆåŠŸï¼Œæ›´æ–° nextIndex ä¸ matchIndex</li>
<li>å¦‚æœæ”¶åˆ°å¤åˆ¶å¤±è´¥ï¼ŒnextIndex -= 1ï¼Œåœ¨ä¸‹æ¬¡å¿ƒè·³ä¸­é‡è¯•</li>
</ol>
</li>
</ul>
<h4 id="ä¸€ä¸ªå…·ä½“ä¾‹å­">ä¸€ä¸ªå…·ä½“ä¾‹å­ <a href="#%e4%b8%80%e4%b8%aa%e5%85%b7%e4%bd%93%e4%be%8b%e5%ad%90" class="anchor">ğŸ”—</a></h4><p>å¦‚å›¾ï¼Œä¸€ä¸ª Raft åˆ°äº†ç°åœ¨çš„çŠ¶æ€</p>
<p><p class="markdown-image">
  <img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20211228140653187-2021-12-28.png" alt="image-20211228140653187"  />
</p></p>
<p>æ”¾å‡ºå„ä¸ª Raft å®ä¾‹ä¸­å­—æ®µçš„å€¼ï¼ŒåŠ æ·±å¯¹å„ä¸ªå­—æ®µç†è§£</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align:center">Leader0</th>
<th style="text-align:center">Follower1</th>
<th style="text-align:center">Follower2</th>
<th style="text-align:center">Follower3</th>
<th style="text-align:center">Follower4</th>
</tr>
</thead>
<tbody>
<tr>
<td>currentTerm</td>
<td style="text-align:center">3</td>
<td style="text-align:center">3(å¯èƒ½æ‰çº¿)</td>
<td style="text-align:center">3</td>
<td style="text-align:center">å®Œå…¨æ‰çº¿</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td>voteFor</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">3</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td>log</td>
<td style="text-align:center">[1,1,1,2,3,3,3,3]</td>
<td style="text-align:center">[1,1,1,2,3]</td>
<td style="text-align:center">[1,1,1,2,3,3,3,3]</td>
<td style="text-align:center">[1,1]</td>
<td style="text-align:center">[1,1,1,2,3,3,3]</td>
</tr>
<tr>
<td>commitIndex(2B)</td>
<td style="text-align:center">7</td>
<td style="text-align:center">4</td>
<td style="text-align:center">7</td>
<td style="text-align:center">1</td>
<td style="text-align:center">6</td>
</tr>
<tr>
<td>lastApplied(2B)</td>
<td style="text-align:center">7</td>
<td style="text-align:center">4</td>
<td style="text-align:center">7</td>
<td style="text-align:center">1</td>
<td style="text-align:center">6</td>
</tr>
<tr>
<td>nextIndex</td>
<td style="text-align:center">[9,6,9,3,8]</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td>matchIndex</td>
<td style="text-align:center">[8,5,8,2,7]</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<p>å¦‚æœ leader æ­¤æ—¶å‘èµ·å¿ƒè·³ï¼Œ AppendEntries è¯·æ±‚å‚æ•°:</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align:center">Follower1</th>
<th style="text-align:center">Follower2</th>
<th style="text-align:center">Follower3</th>
<th style="text-align:center">Follower4</th>
</tr>
</thead>
<tbody>
<tr>
<td>term</td>
<td style="text-align:center">3</td>
<td style="text-align:center">3</td>
<td style="text-align:center">3</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td>leaderID</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td>prevLogIndex</td>
<td style="text-align:center">5</td>
<td style="text-align:center">8</td>
<td style="text-align:center">2</td>
<td style="text-align:center">7</td>
</tr>
<tr>
<td>prevLogTerm</td>
<td style="text-align:center">3</td>
<td style="text-align:center">3</td>
<td style="text-align:center">1</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td>entries</td>
<td style="text-align:center">[3,3,3]</td>
<td style="text-align:center">[]</td>
<td style="text-align:center">[1,2,3,3,3,3]</td>
<td style="text-align:center">[3]</td>
</tr>
<tr>
<td>leaderCommit</td>
<td style="text-align:center">7</td>
<td style="text-align:center">7</td>
<td style="text-align:center">7</td>
<td style="text-align:center">7</td>
</tr>
</tbody>
</table>
<p>å¦‚æœ æ­¤æ—¶ leader 1 ä¹Ÿå®Œå…¨æ‰çº¿äº†ï¼ŒFollower 1, 2, 4 éƒ½æœ‰å¯èƒ½å‘èµ·é€‰ä¸¾ï¼ˆ2 ä¹Ÿæœ‰å¯èƒ½ï¼Œè¿™é‡Œä¸è®¨è®ºäº†ï¼‰ï¼Œåˆ†åˆ«çœ‹ä¸€ä¸‹å¯èƒ½å‘èµ·çš„ç¬¬ä¸€è½®é€‰ä¸¾ RequestVote args</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align:center">Follower1</th>
<th style="text-align:center">Follower2</th>
<th style="text-align:center">Follower4</th>
</tr>
</thead>
<tbody>
<tr>
<td>term</td>
<td style="text-align:center">4</td>
<td style="text-align:center">4</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td>candidateID</td>
<td style="text-align:center">1</td>
<td style="text-align:center">2</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td>lastLogIndex</td>
<td style="text-align:center">5</td>
<td style="text-align:center">8</td>
<td style="text-align:center">7</td>
</tr>
<tr>
<td>LastLogTerm</td>
<td style="text-align:center">3</td>
<td style="text-align:center">3</td>
<td style="text-align:center">3</td>
</tr>
</tbody>
</table>
<h4 id="è®¡æ—¶å™¨å¦‚ä½•å®ç°">è®¡æ—¶å™¨å¦‚ä½•å®ç° <a href="#%e8%ae%a1%e6%97%b6%e5%99%a8%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0" class="anchor">ğŸ”—</a></h4><ol>
<li>åœ¨ä¸€ä¸ªåç¨‹é‡Œç”¨æ­»å¾ªç¯</li>
<li>sleep ä¸€ä¸ªçŸ­çš„æ—¶é—´é—´éš”ï¼ˆ5msï¼‰å»æ£€æŸ¥è¶…æ—¶æ—¶é—´ä¸å½“å‰æ—¶é—´ï¼Œå¦‚æœ Now() å¤§äº è¶…æ—¶æ—¶é—´ï¼Œåˆ™è¯´æ˜è¶…æ—¶äº†ï¼Œéœ€è¦è¿›è¡Œé€»è¾‘å¤„ç†</li>
<li>å…¶å®ƒåç¨‹å¯ä»¥ä¸æ–­é‡ç½®è¶…æ—¶æ—¶é—´</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">killed</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">loadTimeout</span>()) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// do ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">resetTimeout</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">electionTimeout</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#a6e22e">ElectionTimeoutMinMs</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#a6e22e">ElectionTimeOutMaxMs</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ElectionTimeoutMinMs</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">HeartbeatMs</span> = <span style="color:#ae81ff">100</span>    <span style="color:#75715e">// leader 100Ms å‘èµ·ä¸€æ¬¡å¿ƒè·³
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ElectionTimeoutMinMs</span> = <span style="color:#ae81ff">250</span> <span style="color:#75715e">// æœ€å°çš„é€‰ä¸¾æ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ElectionTimeOutMaxMs</span> = <span style="color:#ae81ff">400</span>    <span style="color:#75715e">// æœ€å¤§çš„é€‰ä¸¾æ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>)
</span></span></code></pre></div><h4 id="ä¸ªäººç»éªŒä¸è¸©å‘">ä¸ªäººç»éªŒä¸è¸©å‘ <a href="#%e4%b8%aa%e4%ba%ba%e7%bb%8f%e9%aa%8c%e4%b8%8e%e8%b8%a9%e5%9d%91" class="anchor">ğŸ”—</a></h4><h5 id="1-raft-å®ç°-log-index-ä»-1-å¼€å§‹">1. Raft å®ç° Log Index ä» 1 å¼€å§‹ <a href="#1-raft-%e5%ae%9e%e7%8e%b0-log-index-%e4%bb%8e-1-%e5%bc%80%e5%a7%8b" class="anchor">ğŸ”—</a></h5><ul>
<li>Index = 0 å³ä»£è¡¨åˆšå¯åŠ¨æ—¶çš„ Raftï¼Œè¿˜æ²¡æœ‰ä¸€æ¡ Logï¼Œæ­¤æ—¶å‘èµ·æŠ•ç¥¨æˆ–è€…å¿ƒè·³ï¼Œéœ€è¦å¤„ç†è¿™ä¸ªç‰¹æ®Šçš„ logï¼Œmock ä¸€ä¸ª termä¸º -1çš„ log è¿”å›ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">getLog</span>(<span style="color:#a6e22e">index</span> <span style="color:#66d9ef">int</span>) <span style="color:#a6e22e">LogEntry</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">LogEntry</span>{<span style="color:#a6e22e">Term</span>: <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">logs</span>[<span style="color:#a6e22e">index</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="2-å¦‚ä½•åŠ é”é˜²æ­¢-race">2. å¦‚ä½•åŠ é”é˜²æ­¢ race <a href="#2-%e5%a6%82%e4%bd%95%e5%8a%a0%e9%94%81%e9%98%b2%e6%ad%a2-race" class="anchor">ğŸ”—</a></h5><ol>
<li>Raft ç»“æ„ä¸­çš„å˜é‡å¤§å¤šæ•°éƒ½æ˜¯æœ‰ç«äº‰çš„ï¼Œä»»ä½•å¯¹ Raft ç»“æ„å˜é‡<strong>è¯»</strong>å†™å‰è¯·åŠ é”</li>
<li>ä¸¤ä¸ª RPC handler éƒ½æ˜¯å¹¶å‘çš„ï¼Œè¯·ç›´æ¥ç»™æ–¹æ³•åŠ é”</li>
<li>å¹¶å‘å¼€å¯ goroutine è¯»å†™å…±äº«å˜é‡åŠ é”</li>
</ol>
<h5 id="3-å¦‚ä½•åŠ é”é˜²æ­¢æ­»é”">3. å¦‚ä½•åŠ é”é˜²æ­¢æ­»é” <a href="#3-%e5%a6%82%e4%bd%95%e5%8a%a0%e9%94%81%e9%98%b2%e6%ad%a2%e6%ad%bb%e9%94%81" class="anchor">ğŸ”—</a></h5><ol>
<li>mutex æ˜¯ä¸å¯é‡å…¥é”</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">loadState</span>()    <span style="color:#75715e">// æ­»é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">loadState</span>() <span style="color:#a6e22e">State</span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="2">
<li>ä¸è¦æŠŠ rpc è¯·æ±‚é”åœ¨é‡Œé¢ï¼Œåœ¨å‰ååˆ†å¼€åŠ é”</li>
<li>ä¸è¦å¿˜è®°é‡Šæ”¾é”ï¼ˆif ä¸­ unlockï¼‰</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span>            <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Leader</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// rf.mu.Unlock() if ä¸­çš„ unlock 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span></code></pre></div><h5 id="4-å¹¶å‘éš¾ä»¥-debugè¯·åœ¨å…³é”®ä½ç½®æ‰“-log">4. å¹¶å‘éš¾ä»¥ debugï¼Œè¯·åœ¨å…³é”®ä½ç½®æ‰“ Log <a href="#4-%e5%b9%b6%e5%8f%91%e9%9a%be%e4%bb%a5-debug%e8%af%b7%e5%9c%a8%e5%85%b3%e9%94%ae%e4%bd%8d%e7%bd%ae%e6%89%93-log" class="anchor">ğŸ”—</a></h5><ul>
<li>Handler æ”¶åˆ° RPC è¯·æ±‚</li>
<li>æ”¶åˆ° RPC å›å¤æ—¶</li>
<li>è§’è‰²èº«ä»½å˜åŒ–æ—¶</li>
<li>&hellip;</li>
</ul>
<h5 id="5-ä¸¤ä¸ª-rpc-å¤„ç†æœ‰ä¸€è‡´çš„ä»£ç é€»è¾‘">5. ä¸¤ä¸ª RPC å¤„ç†æœ‰ä¸€è‡´çš„ä»£ç é€»è¾‘ <a href="#5-%e4%b8%a4%e4%b8%aa-rpc-%e5%a4%84%e7%90%86%e6%9c%89%e4%b8%80%e8%87%b4%e7%9a%84%e4%bb%a3%e7%a0%81%e9%80%bb%e8%be%91" class="anchor">ğŸ”—</a></h5><p>å¦‚ handler å¼€å§‹çš„ä¸€æ®µå¤„ç†é€»è¾‘ä¸€è‡´</p>
<p>æ¥æ”¶åˆ°è¯·æ±‚ï¼Œserver ç«¯çš„é€»è¾‘</p>
<ol>
<li>æ‹’ç» term æ¯”è‡ªå·±å°çš„è¯·æ±‚</li>
<li>æ”¶åˆ° term æ¯”è‡ªå·±å¤§çš„è¯·æ±‚ï¼Œæ›´æ–°termï¼Œè½¬æˆ Followerï¼Œå†å¾€ä¸‹å¤„ç†</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// RequestVote handler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">RequestVote</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RequestVoteArgs</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RequestVoteReply</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rpc handler é€šå¸¸æ˜¯å¹¶å‘ï¼ŒåŠ é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d åœ¨ term %d æ”¶åˆ°äº† RequestVote request %+v&#34;</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>, <span style="color:#a6e22e">args</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rpc handler é€šç”¨çš„è§„åˆ™: args ä¸­ term æ¯” å½“å‰å°ï¼Œç›´æ¥è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Term</span> &lt; <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span> = <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rpc handler é€šç”¨è§„åˆ™: args ä¸­çš„ term æ¯”å½“å‰ server å¤§ï¼Œå½“å‰ server æ›´æ–°ä¸º termï¼Œè½¬æˆ follower
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Term</span> &gt; <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> = <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Term</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">voteFor</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span> = <span style="color:#a6e22e">Follower</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ... 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>å¦‚ client ç«¯</p>
<p>æ”¶åˆ°å›å¤ï¼Œclient é€»è¾‘</p>
<ol>
<li>å¦‚æœ reply çš„ term æ¯”è‡ªå·± term å¤§ï¼Œæ›´æ–°termï¼Œè½¬æˆ Followerï¼Œç›´æ¥è¿”å›</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">sendRequestVote</span>(<span style="color:#a6e22e">i</span>,<span style="color:#a6e22e">args</span>, <span style="color:#a6e22e">reply</span>); !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è¿™äº›å˜é‡å¯èƒ½å¹¶å‘ä¿®æ”¹äº†ï¼Œéœ€è¦æ³¨æ„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// é€šç”¨è§„åˆ™: reply ä¸­ term å¤§äºå½“å‰ï¼Œè½¬ä¸º Follower
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span> &gt; <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> = <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">voteFor</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">toFollower</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ....
</span></span></span></code></pre></div><h5 id="6-å°½é‡ä½¿ç”¨å¤§é”ä¸è¦è€ƒè™‘æ€§èƒ½">6. å°½é‡ä½¿ç”¨å¤§é”ï¼Œä¸è¦è€ƒè™‘æ€§èƒ½ <a href="#6-%e5%b0%bd%e9%87%8f%e4%bd%bf%e7%94%a8%e5%a4%a7%e9%94%81%e4%b8%8d%e8%a6%81%e8%80%83%e8%99%91%e6%80%a7%e8%83%bd" class="anchor">ğŸ”—</a></h5><h5 id="7-logs-å¤åˆ¶è¯·ç”¨æ·±æ‹·è´ä¸ç„¶å¾ˆå¯èƒ½æœ‰å¹¶å‘-race-é—®é¢˜">7. Logs å¤åˆ¶è¯·ç”¨æ·±æ‹·è´ï¼Œä¸ç„¶å¾ˆå¯èƒ½æœ‰å¹¶å‘ race é—®é¢˜ <a href="#7-logs-%e5%a4%8d%e5%88%b6%e8%af%b7%e7%94%a8%e6%b7%b1%e6%8b%b7%e8%b4%9d%e4%b8%8d%e7%84%b6%e5%be%88%e5%8f%af%e8%83%bd%e6%9c%89%e5%b9%b6%e5%8f%91-race-%e9%97%ae%e9%a2%98" class="anchor">ğŸ”—</a></h5><h5 id="8-rpc-è¯·æ±‚å‰åè¯·-double-check">8. RPC è¯·æ±‚å‰åè¯· double checkï¼š <a href="#8-rpc-%e8%af%b7%e6%b1%82%e5%89%8d%e5%90%8e%e8%af%b7-double-check" class="anchor">ğŸ”—</a></h5><ul>
<li>å½“å‰è§’è‰²æ˜¯å¦è¿˜éœ€è¦è¿›è¡Œè¿™ä¸ªåŠ¨ä½œï¼Œ</li>
<li>å½“å‰ term æ˜¯å¦è¿˜éœ€è¦å¤„ç†è¿™ä¸ª å›å¤</li>
<li>å›å¤çš„ term æ˜¯å¦ä¸å‘èµ·çš„ term ä¸€è‡´</li>
</ul>
<h3 id="å…·ä½“å®ç°">å…·ä½“å®ç° <a href="#%e5%85%b7%e4%bd%93%e5%ae%9e%e7%8e%b0" class="anchor">ğŸ”—</a></h3><h4 id="1-å¡«å†™-raft-å’Œä¸¤ä¸ª-rpc-ç»“æ„">1. å¡«å†™ Raft å’Œä¸¤ä¸ª RPC ç»“æ„ <a href="#1-%e5%a1%ab%e5%86%99-raft-%e5%92%8c%e4%b8%a4%e4%b8%aa-rpc-%e7%bb%93%e6%9e%84" class="anchor">ğŸ”—</a></h4><p>æ ¹æ®è®ºæ–‡ä¾è‘«èŠ¦ç”»ç“¢å°±è¡Œï¼ŒåæœŸæ ¹æ®è‡ªå·±éœ€è¦å†åŠ ï¼Œraft ç»“æ„å·²æ”¾è¿‡ï¼Œè¿™é‡Œæ”¾ä¸€ä¸‹ RPC çš„</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AppendEntriesArgs</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Term</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">LeaderID</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PrevLogIndex</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PrevLogTerm</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Entries</span> []<span style="color:#a6e22e">LogEntry</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">LeaderCommit</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AppendEntriesReply</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Term</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Success</span> <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">sendAppendEntries</span>(<span style="color:#a6e22e">server</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AppendEntriesArgs</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AppendEntriesReply</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">peers</span>[<span style="color:#a6e22e">server</span>].<span style="color:#a6e22e">Call</span>(<span style="color:#e6db74">&#34;Raft.AppendEntries&#34;</span>, <span style="color:#a6e22e">args</span>, <span style="color:#a6e22e">reply</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ok</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// AppendEntries handler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">AppendEntries</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AppendEntriesArgs</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AppendEntriesReply</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">RequestVoteArgs</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Term</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">CandidateID</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">LastLogIndex</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">LastLogTerm</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">RequestVoteReply</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Term</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">VoteGranted</span> <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">sendRequestVote</span>(<span style="color:#a6e22e">server</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RequestVoteArgs</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RequestVoteReply</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">peers</span>[<span style="color:#a6e22e">server</span>].<span style="color:#a6e22e">Call</span>(<span style="color:#e6db74">&#34;Raft.RequestVote&#34;</span>, <span style="color:#a6e22e">args</span>, <span style="color:#a6e22e">reply</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ok</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// RequestVote handler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">RequestVote</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RequestVoteArgs</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RequestVoteReply</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="2-å¯åŠ¨-raftåˆå§‹åŒ–">2. å¯åŠ¨ Raftï¼Œåˆå§‹åŒ– <a href="#2-%e5%90%af%e5%8a%a8-raft%e5%88%9d%e5%a7%8b%e5%8c%96" class="anchor">ğŸ”—</a></h4><ol>
<li>ä¸€äº›çŠ¶æ€çš„åˆå§‹èµ‹å€¼ï¼Œå¦‚åˆšå¯åŠ¨çš„ raft è§’è‰²æ˜¯ follower</li>
<li>å¯åŠ¨æ£€æµ‹é€‰ä¸¾è¶…æ—¶çš„åç¨‹</li>
<li>å¯¹äº 2B è¿˜éœ€è¦åœ¨å®šæœŸåº”ç”¨ commited çš„ log åˆ°ä¸Šå±‚åº”ç”¨</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Make</span>(<span style="color:#a6e22e">peers</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">labrpc</span>.<span style="color:#a6e22e">ClientEnd</span>, <span style="color:#a6e22e">me</span> <span style="color:#66d9ef">int</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">persister</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Persister</span>, <span style="color:#a6e22e">applyCh</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">ApplyMsg</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Raft</span>{}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">peers</span> = <span style="color:#a6e22e">peers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">persister</span> = <span style="color:#a6e22e">persister</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span> = <span style="color:#a6e22e">me</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">applyCh</span> = <span style="color:#a6e22e">applyCh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Your initialization code here (2A, 2B, 2C).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">toFollower</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">voteFor</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">resetTimeout</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// initialize from state persisted before a crash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">readPersist</span>(<span style="color:#a6e22e">persister</span>.<span style="color:#a6e22e">ReadRaftState</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// start ticker goroutine to start elections
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">ticker</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">applyMsgToUpper</span>()    <span style="color:#75715e">// for 2B
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rf</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="3-leader-é€‰ä¸¾çš„é€»è¾‘">3. leader é€‰ä¸¾çš„é€»è¾‘ <a href="#3-leader-%e9%80%89%e4%b8%be%e7%9a%84%e9%80%bb%e8%be%91" class="anchor">ğŸ”—</a></h4><p>ä¸Šé¢çš„åˆå§‹åŒ–ä¸­ï¼Œå¯åŠ¨äº† <code>go rf.ticker()</code>çš„åç¨‹ï¼Œç°åœ¨éœ€è¦å®ç° leader é€‰ä¸¾è¿™ä¸€éƒ¨åˆ†é€»è¾‘</p>
<ol>
<li>
<p>ä¸€ä¸ªæ­»å¾ªç¯ï¼Œè®¡æ—¶å™¨çš„å®ç°</p>
</li>
<li>
<p>å¦‚æœå…¶è§’è‰²ä¸æ˜¯ leader å¹¶ä¸”è¿‡äº†é€‰ä¸¾æ—¶é—´ï¼Œå‘èµ·é€‰ä¸¾</p>
</li>
<li>
<p>æˆä¸º candiate, ç»™è‡ªå·±æŠ•ä¸€ç¥¨</p>
</li>
<li>
<p>å¹¶å‘å¯¹å…¶å®ƒæ‰€æœ‰ Raft å®ä¾‹å‘èµ·è¯·æ±‚</p>
</li>
<li>
<p>ç”±äº RPC æ¶ˆæ¯å»¶è¿Ÿæ¯”è¾ƒå¤§ï¼Œå› æ­¤éœ€è¦ double checkï¼Œå½“å‰å®ä¾‹çš„çŠ¶æ€æ˜¯å¦èƒ½æŠ•ç¥¨</p>
</li>
<li>
<p>è®¡æ•°å¾—åˆ°ç¥¨æ•°ï¼Œç¥¨æ•°è¶…è¿‡ä¸€åŠï¼Œå½“é€‰ä¸º Leader</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// The ticker go routine starts a new election if this peer hasn&#39;t received
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// heartsbeats recently.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">ticker</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">killed</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// çŠ¶æ€ä¸æ˜¯ Leader, å¹¶ä¸”å·²ç»è¿‡äº†é€‰ä¸¾æ—¶é—´ï¼Œéœ€è¦å‘èµ·é€‰ä¸¾
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">loadState</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Leader</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">loadTimeout</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 1. æˆä¸º candidate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">toCandidate</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 2. å‘èµ·æŠ•ç¥¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">numVote</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// æ‰€æœ‰ requestVote çš„è¯·æ±‚å‚æ•°ä¸€è‡´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">args</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">RequestVoteArgs</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Term</span>:         <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">CandidateID</span>:  <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">LastLogIndex</span>: <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLastIndex</span>(),
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">LastLogTerm</span>:  <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLog</span>(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLastIndex</span>()).<span style="color:#a6e22e">Term</span>,
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">peers</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">RequestVoteReply</span>{}
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// ä¸èƒ½ä»¥ä¸æ˜¯ Candidate çš„èº«ä»½å‘é€æŠ•ç¥¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">loadState</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Candidate</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// rpc è¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">sendRequestVote</span>(<span style="color:#a6e22e">i</span>,<span style="color:#a6e22e">args</span>, <span style="color:#a6e22e">reply</span>); !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// è¿™äº›å˜é‡å¯èƒ½å¹¶å‘ä¿®æ”¹äº†ï¼Œéœ€è¦æ³¨æ„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// é€šç”¨è§„åˆ™: reply ä¸­ term å¤§äºå½“å‰ï¼Œè½¬ä¸º Follower
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span> &gt; <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> = <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">voteFor</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">toFollower</span>()
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// double checkï¼Œå› ä¸ºæœ‰å¯èƒ½å‘èµ·æ–°ä¸€è½®é€‰ä¸¾äº†ï¼Œæ‰æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Candidate</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Term</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// æŠ•ç¥¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">VoteGranted</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">numVote</span> <span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d åœ¨ term %d æ”¶åˆ°äº† %d çš„æŠ•ç¥¨ï¼Œç°åœ¨ç¥¨æ•° %d&#34;</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>, <span style="color:#a6e22e">i</span>,<span style="color:#a6e22e">numVote</span>)
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// æˆä¸º Leader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">numVote</span> &gt; len(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">peers</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">toLeader</span>()
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸è§’è‰²è½¬æ¢çš„æ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">toFollower</span>()  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d åœ¨term %d æˆä¸º follower&#34;</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span> = <span style="color:#a6e22e">Follower</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">toCandidate</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> <span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d åœ¨ term %d å‘èµ·äº†æŠ•ç¥¨&#34;</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>,<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">voteFor</span> = <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span> = <span style="color:#a6e22e">Candidate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">resetTimeout</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸ log çš„æœ‰å…³çš„å·¥å…·æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">getLastIndex</span>() <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">logs</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">getLog</span>(<span style="color:#a6e22e">index</span> <span style="color:#66d9ef">int</span>) <span style="color:#a6e22e">LogEntry</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">LogEntry</span>{<span style="color:#a6e22e">Term</span>: <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">logs</span>[<span style="color:#a6e22e">index</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åŒ…æ‹¬: start å’Œ end, æ·±æ‹·è´ï¼Œä¸ç„¶æé™æƒ…å†µä¸‹ä¼šæœ‰ race çš„ bug
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">subLog</span>(<span style="color:#a6e22e">start</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">end</span> <span style="color:#66d9ef">int</span>) []<span style="color:#a6e22e">LogEntry</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">start</span> <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> append([]<span style="color:#a6e22e">LogEntry</span>{}, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">logs</span>[:<span style="color:#a6e22e">end</span>]<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">end</span> <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> append([]<span style="color:#a6e22e">LogEntry</span>{}, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">logs</span>[<span style="color:#a6e22e">start</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:]<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> append([]<span style="color:#a6e22e">LogEntry</span>{}, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">logs</span>[<span style="color:#a6e22e">start</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>: <span style="color:#a6e22e">end</span>]<span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="4-requestvote-server-ç«¯çš„é€»è¾‘">4. RequestVote server ç«¯çš„é€»è¾‘ <a href="#4-requestvote-server-%e7%ab%af%e7%9a%84%e9%80%bb%e8%be%91" class="anchor">ğŸ”—</a></h4><p>åœ¨å‰é¢å·²ç»æè¿°å¤§è‡´é€»è¾‘äº†ï¼Œå‰é¢ä¸€å¤§å †éƒ½æ˜¯å…±æœ‰é€»è¾‘ï¼Œ20 è¡Œå¼€å§‹æ‰æ˜¯çœŸæ­£å¤„ç†é€»è¾‘ï¼Œè¿™é‡Œç›´æ¥çœ‹ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// RequestVote handler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">RequestVote</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RequestVoteArgs</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RequestVoteReply</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rpc handler é€šå¸¸æ˜¯å¹¶å‘ï¼ŒåŠ é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d åœ¨ term %d æ”¶åˆ°äº† RequestVote request %+v&#34;</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>, <span style="color:#a6e22e">args</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rpc handler é€šç”¨çš„è§„åˆ™: args ä¸­ term æ¯” å½“å‰å°ï¼Œç›´æ¥è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Term</span> &lt; <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span> = <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rpc handler é€šç”¨è§„åˆ™: args ä¸­çš„ term æ¯”å½“å‰ server å¤§ï¼Œå½“å‰ server æ›´æ–°ä¸º termï¼Œè½¬æˆ follower
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Term</span> &gt; <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> = <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Term</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">voteFor</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span> = <span style="color:#a6e22e">Follower</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span> = <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lastIndex</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLastIndex</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å‘èµ·æŠ•ç¥¨çš„ candidate è¦æ¯”å½“å‰æœ‰æ›´æ–°çš„ log
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">isNewer</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLog</span>(<span style="color:#a6e22e">lastIndex</span>).<span style="color:#a6e22e">Term</span> &gt; <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">LastLogTerm</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">isNewer</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLog</span>(<span style="color:#a6e22e">lastIndex</span>).<span style="color:#a6e22e">Term</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">LastLogTerm</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">lastIndex</span> &gt; <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">LastLogIndex</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">isNewer</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">voteFor</span> <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">voteFor</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">CandidateID</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">isNewer</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d åœ¨ term %d ç»™ %d æŠ•ç¥¨&#34;</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>,<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>,<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">CandidateID</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">voteFor</span> = <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">CandidateID</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">VoteGranted</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="5-å½“é€‰ä¸º-leader">5. å½“é€‰ä¸º Leader <a href="#5-%e5%bd%93%e9%80%89%e4%b8%ba-leader" class="anchor">ğŸ”—</a></h4><ol>
<li>åˆå§‹åŒ– nextIndex ä¸ matchIndex æ•°ç»„</li>
<li>å¼€å¯å¿ƒè·³åå°åç¨‹</li>
<li>å¼€å¯åå°æ›´æ–° commitIndex åç¨‹</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">toLeader</span>() {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d åœ¨term %d æˆä¸ºäº† leader&#34;</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>,<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>)
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span> = <span style="color:#a6e22e">Leader</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// æˆä¸º leader è¦åˆå§‹åŒ– nextIndex matchIndex æ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">nextIndex</span> = make([]<span style="color:#66d9ef">int</span>, len(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">peers</span>))
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">matchIndex</span> = make([]<span style="color:#66d9ef">int</span>, len(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">peers</span>))
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; len(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">peers</span>); <span style="color:#a6e22e">i</span> <span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">nextIndex</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLastIndex</span>() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">heartbeat</span>()
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">updateCommitIndex</span>()    <span style="color:#75715e">// for 2b
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h4 id="6-leader-å‘èµ·å¿ƒè·³æ—¥å¿—å¤åˆ¶rpc">6. leader å‘èµ·å¿ƒè·³ï¼ˆæ—¥å¿—å¤åˆ¶ï¼‰RPC <a href="#6-leader-%e5%8f%91%e8%b5%b7%e5%bf%83%e8%b7%b3%e6%97%a5%e5%bf%97%e5%a4%8d%e5%88%b6rpc" class="anchor">ğŸ”—</a></h4><p>å®šæœŸå‘èµ·å¿ƒè·³, è§’è‰²ä¸æ˜¯ leaderï¼Œé€€å‡ºè¿™ä¸ªåç¨‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">heartbeat</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">killed</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d åœ¨ term %d è§¦å‘å¿ƒè·³, state: %d, nextIndex: %+v&#34;</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">nextIndex</span>) <span style="color:#75715e">// å…±äº«å˜é‡è®¿é—® è¦åŠ é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Leader</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">sendAppendLogsToAll</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">HeartbeatMs</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>æŠŠå¿ƒè·³ï¼ˆå¤åˆ¶æ—¥å¿—ï¼‰çš„ RPC å¹¶å‘å‘é€åˆ°æ¯ä¸ª RPC å®ä¾‹ï¼Œé€»è¾‘åœ¨ä¸Šæ–‡ä¸­æåˆ°ï¼Œè¿™é‡Œç›´æ¥çœ‹ä»£ç ç†è§£</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">sendAppendLogsToAll</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//log.Printf(&#34;%d åœ¨ term %d å‘èµ·åŒæ­¥&#34;, rf.me, rf.currentTerm) // è¿™é‡Œ CurrentTerm æ²¡åŠ é”ï¼Œå¯èƒ½ä¼šæœ‰ race
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">peers</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">args</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">AppendEntriesArgs</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Term</span>:         <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">LeaderID</span>:     <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">PrevLogIndex</span>: <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">nextIndex</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">PrevLogTerm</span>:  <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLog</span>(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">nextIndex</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>).<span style="color:#a6e22e">Term</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Entries</span>:      <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">subLog</span>(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">nextIndex</span>[<span style="color:#a6e22e">i</span>], <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">LeaderCommit</span>: <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">commitIndex</span>,
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">AppendEntriesReply</span>{}
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// è¿™ä¸ªæ£€æŸ¥æ˜¯å› ä¸ºå½“ä¸€ä¸ªåç¨‹æ”¶åˆ°æ¯”å½“å‰ term å¤§çš„ replyï¼Œä¼šè½¬å˜æˆ follower. åé¢åç¨‹ä¸åº”è¯¥å†ä»¥ leader èº«ä»½å‘é€åŒæ­¥ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Leader</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">sendAppendEntries</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">args</span>, <span style="color:#a6e22e">reply</span>); !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d åœ¨ term %d æ”¶åˆ° %d çš„AppendEntries reply %+v&#34;</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>, <span style="color:#a6e22e">i</span>,<span style="color:#a6e22e">reply</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// æ‰€æœ‰ server çš„è§„åˆ™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span> &gt; <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> = <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">voteFor</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">toFollower</span>()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// double check
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Leader</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Term</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Success</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// rf.nextIndex[i] += len(args.Entries) èµ°è¿‡çš„ä¸€ä¸ª bug
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// rf.matchIndex[i] = rf.nextIndex[i] - 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">nextIndex</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">PrevLogIndex</span> <span style="color:#f92672">+</span> len(<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Entries</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">matchIndex</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">PrevLogIndex</span> <span style="color:#f92672">+</span> len(<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Entries</span>)
</span></span><span style="display:flex;"><span>            }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å®é™…ä¸ŠæŠŠé‡è¯•çš„æœºåˆ¶æ¨åˆ°äº†ä¸‹æ¬¡å¿ƒè·³ 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">nextIndex</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">PrevLogIndex</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="7-appendentries-server-å¤„ç†é€»è¾‘">7. AppendEntries server å¤„ç†é€»è¾‘ <a href="#7-appendentries-server-%e5%a4%84%e7%90%86%e9%80%bb%e8%be%91" class="anchor">ğŸ”—</a></h4><p>è¿™é‡Œå¤„ç†çš„å‡†åˆ™ï¼Œå„ä¸ª server ä¹‹é—´ prevLogIndex ä¹‹å‰çš„æ—¥å¿—ä¿æŒä¸€è‡´ï¼Œæ‰èƒ½å¢åŠ æ–°çš„ logã€‚</p>
<ul>
<li>
<p>å°‘ log çš„è¡¥ä¸Š (é‡è¯•ï¼šä¸‹ä¸€æ¬¡ prevLogIndex - 1)</p>
</li>
<li>
<p>ä¸ä¸€è‡´çš„åˆ æ‰</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// AppendEntries handler
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">AppendEntries</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AppendEntriesArgs</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AppendEntriesReply</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rpc handler é€šå¸¸æ˜¯å¹¶å‘ï¼ŒåŠ é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d åœ¨ term %d æ”¶åˆ° %d çš„ AppendEntries request %+v&#34;</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">LeaderID</span>, <span style="color:#a6e22e">args</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rpc handler é€šç”¨çš„è§„åˆ™: args ä¸­ term æ¯” å½“å‰å°ï¼Œç›´æ¥è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Term</span> &lt; <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span> = <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rpc handler é€šç”¨è§„åˆ™: args ä¸­çš„ term æ¯”å½“å‰ server å¤§ï¼Œå½“å‰ server æ›´æ–°ä¸º termï¼Œè½¬æˆ follower
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Term</span> &gt; <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> = <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Term</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">voteFor</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">toFollower</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">resetTimeout</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Term</span> = <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è°ƒç”¨è€…éœ€è¦å‡å°‘ PrevLogIndexï¼Œé‡è¯•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLastIndex</span>() &lt; <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">PrevLogIndex</span> <span style="color:#f92672">||</span>  <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLog</span>(<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">PrevLogIndex</span>).<span style="color:#a6e22e">Term</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">PrevLogTerm</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Success</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åˆ é™¤æ¯” leader å¤šçš„ log
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">logs</span> = <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">subLog</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">PrevLogIndex</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ–°å¢çš„ Entries æ”¾å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">logs</span> = append(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">logs</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">Entries</span><span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ›´æ–°æˆ Follower çš„ commit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">LeaderCommit</span> &gt; <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">commitIndex</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">commitIndex</span> = <span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">LeaderCommit</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLastIndex</span>())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åˆ°è¿™ä¸€æ­¥ 2a çš„é€»è¾‘å·²å®Œæˆï¼Œä¸‹é¢æ˜¯å¤„ç† 2b æ‰€éœ€è¦çš„ã€‚</p>
<h4 id="8-leader-æ›´æ–°-commitindex">8. leader æ›´æ–° commitIndex <a href="#8-leader-%e6%9b%b4%e6%96%b0-commitindex" class="anchor">ğŸ”—</a></h4><p>å®šæœŸå»æ£€æŸ¥ commiteIndex + 1 çš„ Log æ˜¯å¦å¤åˆ¶åˆ°å¤§å¤šæ•°æœºå™¨ä¸Š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">updateCommitIndex</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">killed</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLastIndex</span>(); <span style="color:#a6e22e">n</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">commitIndex</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">n</span> <span style="color:#f92672">--</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// è®ºæ–‡ä¸­æåˆ°åªèƒ½æäº¤å½“å‰ä»»æœŸçš„æ—¥å¿—ï¼Œä½†æˆ‘æš‚æ—¶æ„Ÿè§‰æœ‰ç‚¹æ— æ„ä¹‰ï¼Œå› ä¸ºè¿™æ ·ä¸è¿˜æ˜¯é¡ºå¸¦æŠŠä»»æœŸå°çš„æäº¤äº†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLog</span>(<span style="color:#a6e22e">n</span>).<span style="color:#a6e22e">Term</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">count</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">matchIndex</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">matchIndex</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">n</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">count</span> <span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">count</span> &gt; len(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">peers</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">commitIndex</span> = <span style="color:#a6e22e">n</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Microsecond</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="10-æŠŠæ¶ˆæ¯åº”ç”¨åˆ°ä¸Šå±‚">10. æŠŠæ¶ˆæ¯åº”ç”¨åˆ°ä¸Šå±‚ <a href="#10-%e6%8a%8a%e6%b6%88%e6%81%af%e5%ba%94%e7%94%a8%e5%88%b0%e4%b8%8a%e5%b1%82" class="anchor">ğŸ”—</a></h4><p>ä¹Ÿæ˜¯å®šæœŸå»æ£€æŸ¥æ˜¯å¦å­˜åœ¨å·² commited çš„ log æ²¡æœ‰åº”ç”¨åˆ°ä¸Šå±‚åº”ç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">applyMsgToUpper</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">killed</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">commitIndex</span> &gt; <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">lastApplied</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">lastApplied</span> <span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ApplyMsg</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">CommandValid</span>:  <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Command</span>:       <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLog</span>(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">lastApplied</span>).<span style="color:#a6e22e">Command</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">CommandIndex</span>:  <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">lastApplied</span>,
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">applyCh</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">msg</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d åœ¨ term %d å¾€ä¸Šå±‚çŠ¶æ€æœºæˆåŠŸå‘é€ Msg %+v&#34;</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>, <span style="color:#a6e22e">msg</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">10</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="11-æ¥å—ä¸Šå±‚åº”ç”¨æ¶ˆæ¯">11. æ¥å—ä¸Šå±‚åº”ç”¨æ¶ˆæ¯ <a href="#11-%e6%8e%a5%e5%8f%97%e4%b8%8a%e5%b1%82%e5%ba%94%e7%94%a8%e6%b6%88%e6%81%af" class="anchor">ğŸ”—</a></h4><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">rf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Raft</span>) <span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">command</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">term</span>, <span style="color:#a6e22e">isLeader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">currentTerm</span>, <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">Leader</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">isLeader</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">term</span>, <span style="color:#a6e22e">isLeader</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">logs</span> = append(<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">logs</span>, <span style="color:#a6e22e">LogEntry</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Command</span>: <span style="color:#a6e22e">command</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Term</span>: <span style="color:#a6e22e">term</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">nextIndex</span>[<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>] = <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLastIndex</span>() <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">matchIndex</span>[<span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">me</span>] = <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLastIndex</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rf</span>.<span style="color:#a6e22e">getLastIndex</span>(), <span style="color:#a6e22e">term</span>, <span style="color:#a6e22e">isLeader</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="æ€»ç»“">æ€»ç»“ <a href="#%e6%80%bb%e7%bb%93" class="anchor">ğŸ”—</a></h2><p>ä¸Šè¿°å°±æ˜¯æˆ‘ Raft 2a 2b éƒ¨åˆ†çš„å®ç°é€»è¾‘äº†ï¼Œä¸Šè¿°æ¶‰åŠä»£ç å¯èƒ½ä¸å¤ªé½å…¨ï¼Œä¸è¿‡ç›¸ä¿¡ä½ èƒ½å¤Ÿè¡¥é½ã€‚</p>
<p>åœ¨æµ‹è¯•ä¸­è¯·å¤šè·‘å‡ æ¬¡è„šæœ¬ï¼ˆ10 æ¬¡ï¼Ÿï¼‰ï¼Œä¸€ä¸¤æ¬¡æ—  bug å‡ºç°å¯èƒ½åªæ˜¯è¿æ°”å¥½</p>
<p>ä¸ªäººæµ‹è¯•ä¸Šè¿°çš„å®ç°ï¼Œåœ¨ 2a 2b æµ‹è¯•æ ·ä¾‹ä¸­èƒ½å®Œç¾è¿è¡Œï¼Œå¦‚æœä½ å‘ç°ä¸Šè¿°å®ç°å­˜åœ¨ bugï¼Œè¯·è¯„è®ºå‘ŠçŸ¥æˆ‘ã€‚</p>

    </div>

    
        <div class="tags">
            
                <a href="https://he2121.github.io/xiaohe-blog/tags/6.824">6.824</a>
            
                <a href="https://he2121.github.io/xiaohe-blog/tags/lab">lab</a>
            
                <a href="https://he2121.github.io/xiaohe-blog/tags/raft">raft</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/he2121/" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>


</div>

    

    <div class="copyright">
    
       Â© Copyright 
       2023 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       å°è´º
    
    </div>

    
</footer>



  </body>
</html>
