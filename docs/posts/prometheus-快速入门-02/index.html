<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <title>Prometheus å¿«é€Ÿå…¥é—¨-02 | å°è´ºçš„åšå®¢</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="æ•°æ®æ¨¡å‹ ğŸ”—Prometheus åº•å±‚å°†æ‰€æœ‰æ•°æ®å­˜å‚¨ä¸ºæ—¶é—´åºåˆ—: å³ä»¥ç›¸åŒ metric å’Œ label ç»´åº¦èšåˆçš„å¸¦æ—¶é—´æˆ³çš„æµã€‚
æ—¶åºæ ¼å¼ ğŸ”—ä¸‹é¢æ ¼å¼è¡¨ç¤ºä¸€ä¸ª metric å’Œ label çš„æ—¶åºæ•°æ®é›†åˆ
&lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, ...} ä¾‹å¦‚ï¼Œä¸€ä¸ªæ—¶é—´åºåˆ—çš„åº¦é‡åç§° api_http_requests_total å’Œ label æ–¹æ³•=&ldquo;POST&rdquo; å’Œhandler=&quot;/messages&quot;å¯ä»¥å†™æˆè¿™æ ·:
api_http_requests_total{method=&#34;POST&#34;, handler=&#34;/messages&#34;} é‡‡æ · ğŸ”—Prometheus é€šè¿‡ pull æ”¶åˆ°å„ä¸ª metric çš„å®é™…æ•°æ®ï¼Œæ ·æœ¬å½¢æˆå®é™…çš„æ—¶é—´åºåˆ—æ•°æ®ï¼Œæ¯ä¸ªæ ·æœ¬åŒ…æ‹¬:
  float64å€¼
  ä¸€ä¸ªæ¯«ç§’ç²¾åº¦æ—¶é—´æˆ³
  å°ç»“ ğŸ”— Prometheus ä»¥ metric å’Œ label çš„ç»´åº¦èšåˆæ—¶åºæ•°æ® Prometheus ä»¥ pull æ–¹å¼ï¼Œæ”¶é›†å„ä¸ªç›‘æ§ç›®æ ‡ä¸Š metric çš„å€¼ä¸æ—¶é—´æˆ³  Metric ç±»å‹ ğŸ”—Prometheus Metric æœ‰å››ç§ç±»å‹ï¼šCounterï¼ŒGaugeï¼ŒHistogramï¼ŒSummary
Counter ğŸ”—  ç‰¹æ€§ï¼šåªå¢ä¸å‡
  é€‚ç”¨ï¼šæœåŠ¡è¯·æ±‚æ•°ã€å·²å®Œæˆä»»åŠ¡æ•°ã€é”™è¯¯å‡ºç°æ¬¡æ•°ç­‰
  ç¤ºä¾‹ï¼šhttp è¯·æ±‚æ•°">
<meta name="generator" content="Hugo 0.89.2" />


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/xiaohe-blog/css/style.css">



<link rel="shortcut icon" href="/xiaohe-blog/images/favicon.ico" type="image/x-icon" />

 
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-FY1WNXTY3L', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







  </head>

  <body>
    <nav class="navigation">
	
		<a href="/xiaohe-blog/"> <span class="arrow">â†</span>é¦–é¡µ</a>
	
	<a href="/xiaohe-blog/posts">å½’æ¡£</a>
	<a href="/xiaohe-blog/tags">æ ‡ç­¾</a>
	<a href="/xiaohe-blog/about">å…³äº</a>

	
		<a href="/xiaohe-blog/%e7%ae%97%e6%b3%95">ç®—æ³•</a>
	
		<a href="/xiaohe-blog/%e6%9d%82%e8%b0%88">æ‚è°ˆ</a>
	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">Prometheus å¿«é€Ÿå…¥é—¨-02</h1>

    <div class="tip">
      <div>2021å¹´12æœˆ8æ—¥</div>
        <span class="split">
          Â·
        </span>
        <span>
          730å­—
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          4åˆ†é’Ÿ è¯»å®Œ
        </span>
        <div class="views">
          <span class="views">
              <img src="https://visitor-badge.glitch.me/badge?page_id=https%3a%2f%2fhe2121.github.io%2fxiaohe-blog%2fposts%2fprometheus-%25E5%25BF%25AB%25E9%2580%259F%25E5%2585%25A5%25E9%2597%25A8-02%2f" alt="Views"/>
          </span>
      </div>
    </div>

    
    


    <div class="content">
      <h2 id="æ•°æ®æ¨¡å‹">æ•°æ®æ¨¡å‹ <a href="#%e6%95%b0%e6%8d%ae%e6%a8%a1%e5%9e%8b" class="anchor">ğŸ”—</a></h2><p>Prometheus åº•å±‚å°†æ‰€æœ‰æ•°æ®å­˜å‚¨ä¸ºæ—¶é—´åºåˆ—:  å³ä»¥ç›¸åŒ metric å’Œ label ç»´åº¦èšåˆçš„å¸¦æ—¶é—´æˆ³çš„æµã€‚</p>
<h3 id="æ—¶åºæ ¼å¼">æ—¶åºæ ¼å¼ <a href="#%e6%97%b6%e5%ba%8f%e6%a0%bc%e5%bc%8f" class="anchor">ğŸ”—</a></h3><p>ä¸‹é¢æ ¼å¼è¡¨ç¤ºä¸€ä¸ª metric å’Œ label çš„æ—¶åºæ•°æ®é›†åˆ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&lt;metric name&gt;<span style="color:#f92672">{</span>&lt;label name&gt;<span style="color:#f92672">=</span>&lt;label value&gt;, ...<span style="color:#f92672">}</span>
</code></pre></div><p>ä¾‹å¦‚ï¼Œä¸€ä¸ªæ—¶é—´åºåˆ—çš„åº¦é‡åç§° api_http_requests_total å’Œ label æ–¹æ³•=&ldquo;POST&rdquo; å’Œhandler=&quot;/messages&quot;å¯ä»¥å†™æˆè¿™æ ·:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">api_http_requests_total<span style="color:#f92672">{</span>method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;POST&#34;</span>, handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/messages&#34;</span><span style="color:#f92672">}</span>
</code></pre></div><h3 id="é‡‡æ ·">é‡‡æ · <a href="#%e9%87%87%e6%a0%b7" class="anchor">ğŸ”—</a></h3><p>Prometheus é€šè¿‡ pull æ”¶åˆ°å„ä¸ª metric çš„å®é™…æ•°æ®ï¼Œæ ·æœ¬å½¢æˆå®é™…çš„æ—¶é—´åºåˆ—æ•°æ®ï¼Œæ¯ä¸ªæ ·æœ¬åŒ…æ‹¬:</p>
<ul>
<li>
<p>float64å€¼</p>
</li>
<li>
<p>ä¸€ä¸ªæ¯«ç§’ç²¾åº¦æ—¶é—´æˆ³</p>
</li>
</ul>
<h3 id="å°ç»“">å°ç»“ <a href="#%e5%b0%8f%e7%bb%93" class="anchor">ğŸ”—</a></h3><ul>
<li>Prometheus ä»¥ metric å’Œ label çš„ç»´åº¦èšåˆæ—¶åºæ•°æ®</li>
<li>Prometheus ä»¥ pull æ–¹å¼ï¼Œæ”¶é›†å„ä¸ªç›‘æ§ç›®æ ‡ä¸Š metric çš„å€¼ä¸æ—¶é—´æˆ³</li>
</ul>
<h2 id="metric-ç±»å‹">Metric ç±»å‹ <a href="#metric-%e7%b1%bb%e5%9e%8b" class="anchor">ğŸ”—</a></h2><p>Prometheus Metric æœ‰å››ç§ç±»å‹ï¼šCounterï¼ŒGaugeï¼ŒHistogramï¼ŒSummary</p>
<h3 id="counter">Counter <a href="#counter" class="anchor">ğŸ”—</a></h3><ul>
<li>
<p><strong>ç‰¹æ€§</strong>ï¼šåªå¢ä¸å‡</p>
</li>
<li>
<p><strong>é€‚ç”¨</strong>ï¼šæœåŠ¡è¯·æ±‚æ•°ã€å·²å®Œæˆä»»åŠ¡æ•°ã€é”™è¯¯å‡ºç°æ¬¡æ•°ç­‰</p>
</li>
<li>
<p><strong>ç¤ºä¾‹</strong>ï¼šhttp è¯·æ±‚æ•°</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># TYPE prometheus_http_requests_total counter</span>
prometheus_http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span>,handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/-/ready&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span>
prometheus_http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span>,handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/api/v1/label/:name/values&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">43</span>
prometheus_http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span>,handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/api/v1/labels&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">35</span>
</code></pre></div><ul>
<li><strong>Go SDK</strong>:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-GO" data-lang="GO"><span style="color:#75715e">// counter + 1
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Inc</span>()
<span style="color:#75715e">// counter + ä»»æ„å€¼ï¼Œè¿™ä¸ªå€¼å°äº 0ï¼Œ åˆ™ panic
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Add</span>(<span style="color:#66d9ef">float64</span>)
</code></pre></div><h3 id="gauge">Gauge <a href="#gauge" class="anchor">ğŸ”—</a></h3><ul>
<li>
<p><strong>ç‰¹æ€§</strong>ï¼šæ•°æ®å¯ä»¥ä»»æ„å˜åŒ–ï¼Œå¯å¢å¯å‡</p>
</li>
<li>
<p><strong>é€‚ç”¨</strong>ï¼šæ¸©åº¦ã€å†…å­˜/ç£ç›˜ä½¿ç”¨ç‡ç­‰</p>
</li>
<li>
<p><strong>ç¤ºä¾‹</strong>ï¼šgo å½“å‰åç¨‹æ•°</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># TYPE go_goroutines gauge</span>
go_goroutines <span style="color:#ae81ff">35</span>
</code></pre></div><ul>
<li><strong>Go SDK</strong>:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// è®¾ç½®ä»»æ„å€¼
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Set</span>(<span style="color:#66d9ef">float64</span>)
<span style="color:#75715e">// åŠ ä¸€
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Inc</span>()
<span style="color:#75715e">// å‡1
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Dec</span>()
<span style="color:#75715e">// åŠ ä»»æ„å€¼
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Add</span>(<span style="color:#66d9ef">float64</span>)
<span style="color:#75715e">// å‡ä»»æ„å€¼
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Sub</span>(<span style="color:#66d9ef">float64</span>)
<span style="color:#75715e">// è®¾ç½®æˆå½“å‰æ—¶é—´çš„ unix ç§’å€¼
</span><span style="color:#75715e"></span><span style="color:#a6e22e">SetToCurrentTime</span>()
</code></pre></div><h3 id="histogramç›´æ–¹å›¾">Histogramï¼ˆç›´æ–¹å›¾ï¼‰ <a href="#histogram%e7%9b%b4%e6%96%b9%e5%9b%be" class="anchor">ğŸ”—</a></h3><ul>
<li><strong>ç‰¹æ€§</strong>ï¼šä¸€æ®µæ—¶é—´èŒƒå›´å†…å¯¹æ•°æ®è¿›è¡Œé‡‡æ ·ï¼Œå¯¹å…¶æŒ‡å®šåŒºé—´ä»¥åŠæ€»æ•°è¿›è¡Œç»Ÿè®¡</li>
<li><strong>é€‚ç”¨</strong>ï¼šé¡µé¢çš„å“åº”æ—¶é—´åˆ†å¸ƒã€resp çš„ body å¤§å°åˆ†å¸ƒç­‰&hellip;</li>
<li><strong>ç¤ºä¾‹</strong>ï¼šhttp è¯·æ±‚å»¶æ—¶</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># HELP prometheus_http_request_duration_seconds Histogram of latencies for HTTP requests.</span>
<span style="color:#75715e"># TYPE prometheus_http_request_duration_seconds histogram</span>
prometheus_http_request_duration_seconds_bucket<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span>,le<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.1&#34;</span><span style="color:#f92672">}</span> 6	// å»¶æ—¶å°äº 0.1 s çš„è¯·æ±‚æ•° <span style="color:#ae81ff">6</span> ä¸ª
prometheus_http_request_duration_seconds_bucket<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span>,le<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.2&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span> // å»¶æ—¶å°äº 0.2 s çš„è¯·æ±‚æ•° <span style="color:#ae81ff">6</span> ä¸ª
prometheus_http_request_duration_seconds_bucket<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span>,le<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.4&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span>
prometheus_http_request_duration_seconds_bucket<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span>,le<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span>
prometheus_http_request_duration_seconds_bucket<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span>,le<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;3&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span>
prometheus_http_request_duration_seconds_bucket<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span>,le<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;8&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span>
prometheus_http_request_duration_seconds_bucket<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span>,le<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;20&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span>
prometheus_http_request_duration_seconds_bucket<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span>,le<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;60&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span>
prometheus_http_request_duration_seconds_bucket<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span>,le<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;120&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">6</span>
prometheus_http_request_duration_seconds_bucket<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span>,le<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;+Inf&#34;</span><span style="color:#f92672">}</span> 6	// è¿™ä¸ªå®é™…ä¸Šç­‰äºæ€»è¯·æ±‚æ•°
prometheus_http_request_duration_seconds_sum<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}</span> 0.00016767900000000003	// ä¸Šè¿°æ ·æœ¬æ±‚å’Œ sum
prometheus_http_request_duration_seconds_count<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">}</span> 6							// è¿™æ¬¡é‡‡æ ·æ€»è¯·æ±‚æ•°
</code></pre></div><ul>
<li><strong>Go SDK</strong> ï¼š</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// è§‚æµ‹è¿™ä¸ªå€¼è½åœ¨äº†å“ªä¸ª buckte ä¸­
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Observe</span>(<span style="color:#66d9ef">float64</span>)
</code></pre></div><h3 id="summary">Summary <a href="#summary" class="anchor">ğŸ”—</a></h3><ul>
<li><strong>ç‰¹æ€§</strong>ï¼šä¸ Histogram ç±»ä¼¼</li>
<li><strong>é€‚ç”¨</strong>ï¼šä¸ Histogram ç±»ä¼¼</li>
<li><strong>ç¤ºä¾‹</strong>ï¼šåƒåœ¾å›æ”¶åœé¡¿æ—¶é—´</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.</span>
<span style="color:#75715e"># TYPE go_gc_duration_seconds summary</span>
go_gc_duration_seconds<span style="color:#f92672">{</span>quantile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span><span style="color:#f92672">}</span> 4.2354e-05
go_gc_duration_seconds<span style="color:#f92672">{</span>quantile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.25&#34;</span><span style="color:#f92672">}</span> 9.222e-05
go_gc_duration_seconds<span style="color:#f92672">{</span>quantile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.5&#34;</span><span style="color:#f92672">}</span> 0.000133648
go_gc_duration_seconds<span style="color:#f92672">{</span>quantile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.75&#34;</span><span style="color:#f92672">}</span> 0.000193116
go_gc_duration_seconds<span style="color:#f92672">{</span>quantile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1&#34;</span><span style="color:#f92672">}</span> 0.00906632
go_gc_duration_seconds_sum 0.064656275
go_gc_duration_seconds_count <span style="color:#ae81ff">295</span>
</code></pre></div><ul>
<li><strong>Go SDK</strong>ï¼š</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// è§‚æµ‹å€¼
</span><span style="color:#75715e"></span><span style="color:#a6e22e">Observe</span>(<span style="color:#66d9ef">float64</span>)
</code></pre></div><h5 id="summary-vs-histogram">Summary VS Histogram <a href="#summary-vs-histogram" class="anchor">ğŸ”—</a></h5><p><strong>ç›¸åŒ</strong></p>
<ul>
<li>éƒ½ç”¨æ¥è¡¨ç¤ºä¸€æ®µæ—¶é—´å†…æ•°æ®é‡‡æ ·ç»“æœ</li>
<li>é€‚ç”¨äºæŸ¥çœ‹å€¼åˆ†å¸ƒçš„åœºæ™¯</li>
</ul>
<p><strong>ä¸åŒç‚¹</strong></p>
<ul>
<li>Histogramï¼šå®¢æˆ·ç«¯åœ¨æ”¶é›†æ•°æ®æ—¶ï¼Œä¸å­˜å‚¨å…·ä½“çš„å€¼ï¼Œè¿˜æ˜¯å¤šä¸ª bucket counterï¼Œæ€§èƒ½ç›¸å¯¹ Counterï¼ŒGauge æ— å·®åˆ«ã€‚ä½†å¯ä»¥åœ¨æœåŠ¡ç«¯è®¡ç®—å‡ºåˆ†ä½æ•°æ®</li>
<li>Summaryï¼š å®¢æˆ·ç«¯æŠŠä¸€æ®µæ—¶é—´å†…ï¼ˆé»˜è®¤æ˜¯10åˆ†é’Ÿï¼‰çš„æ•°æ®å­˜å‚¨ä¸‹æ¥ï¼Œå†å»è®¡ç®—åˆ†ä½æ•°ï¼Œæ€§èƒ½ç›¸å¯¹ä½ä¸€äº›</li>
</ul>
<p><strong>å¦‚ä½•é€‰æ‹©</strong></p>
<ul>
<li>éœ€è¦èšåˆï¼Œé€‰ Histogramã€‚Summary æ— æ³•èšåˆï¼Œå› ä¸ºä¸€èˆ¬è¦ç›‘æ§å¤šå°æœºå™¨ï¼Œè€Œ Summary åœ¨å®¢æˆ·ç«¯è®¡ç®—åˆ†ä½æ•°æ®</li>
<li>åˆ†ä½æ•°æ®è¦ç²¾ç¡®ï¼Œé€‰ Summary</li>
</ul>
<h2 id="pormql-ä½¿ç”¨">PormQL ä½¿ç”¨ <a href="#pormql-%e4%bd%bf%e7%94%a8" class="anchor">ğŸ”—</a></h2><h3 id="pormql-æŸ¥è¯¢è¿”å›æ•°æ®ç±»å‹">PormQL æŸ¥è¯¢è¿”å›æ•°æ®ç±»å‹ <a href="#pormql-%e6%9f%a5%e8%af%a2%e8%bf%94%e5%9b%9e%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b" class="anchor">ğŸ”—</a></h3><ol>
<li><strong>ç¬æ—¶å‘é‡ï¼ˆInstant vectorï¼‰</strong>: åŒ…å«ä¸€ç»„æ—¶åºæ•°æ®ï¼Œé»˜è®¤è¿”å›<strong>æœ€æ–°æ—¶é—´ç‚¹çš„å€¼</strong></li>
</ol>
<p>æŸ¥è¯¢è¯­å¥ï¼Œæ ¼å¼ä¸ä¸Šè¿°æåˆ°çš„<a href="#%e6%97%b6%e5%ba%8f%e6%a0%bc%e5%bc%8f">æ—¶åºæ ¼å¼</a>ä¸€è‡´ï¼Œä¾‹å¦‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">// ä¾‹å­1 æŸ¥è¯¢ http æ¥å£è¯·æ±‚æ•°
http_requests_total
// ä¾‹å­2 æŸ¥è¯¢ http æ¥å£è¯·æ±‚æ•°ï¼Œé™å®š hanlder
http_requests_total<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/api/comments&#34;</span><span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>è¿”å›ç»“æœ</li>
</ul>
<p><p class="markdown-image">
  <img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20211208170850461-2021-12-08.png" alt="image-20211208170850461"  />
</p></p>
<ol start="2">
<li><strong>èŒƒå›´å‘é‡ï¼ˆRange vectorï¼‰</strong>: ä¸€ç»„æ—¶åºæ•°æ®ï¼Œæ¯ä¸ªæ—¶åºæœ‰å¤šä¸ªå€¼ï¼ˆé™å®šåœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œä¸åŒæ—¶é—´ç‚¹çš„å€¼ï¼‰</li>
</ol>
<ul>
<li>æŸ¥è¯¢è¯­å¥ï¼Œ</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">// ä¾‹å­1 æŸ¥è¯¢ http <span style="color:#ae81ff">5</span> åˆ†é’Ÿå†… ä¸ŠæŠ¥æ•°æ®
http_requests_total<span style="color:#f92672">[</span>5m<span style="color:#f92672">]</span>
// ä¾‹å­2 æŸ¥è¯¢ http æŒ‡å®š handler <span style="color:#ae81ff">5</span> åˆ†é’Ÿå†… ä¸ŠæŠ¥çš„æ•°æ®
http_requests_total<span style="color:#f92672">{</span>handler<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/api/comments&#34;</span><span style="color:#f92672">}[</span>5m<span style="color:#f92672">]</span>
</code></pre></div><ul>
<li>
<p>è¿”å›ç»“æœ</p>
<p><p class="markdown-image">
  <img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20211208171741338-2021-12-08.png" alt="image-20211208171741338"  />
</p></p>
</li>
</ul>
<ol start="3">
<li><strong>æ ‡é‡</strong></li>
</ol>
<p>å•çº¯çš„æ•°å­—ï¼š2ï¼Œ2.0</p>
<h3 id="æŸ¥è¯¢è¯­å¥">æŸ¥è¯¢è¯­å¥ <a href="#%e6%9f%a5%e8%af%a2%e8%af%ad%e5%8f%a5" class="anchor">ğŸ”—</a></h3><ol>
<li><code>metric_name{label_name=lable_value}</code>æŸ¥è¯¢å‡ºç¬æ—¶å‘é‡ï¼Œä¾‹å¦‚</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span><span style="color:#f92672">}</span> // è¡¨ç¤ºæŸ¥è¯¢ metric ä¸º http_requests_totalï¼Œlabel code ä¸º <span style="color:#e6db74">&#34;200&#34;</span> çš„æ•°æ®
</code></pre></div><ol start="2">
<li>
<p>ç¬æ—¶æŸ¥è¯¢è¯­å¥ååŠ ä¸Š<code>[time]</code>ï¼Œä¾‹å¦‚<code>metric_name{label_name=lable_value}[5m]</code>è¡¨ç¤ºé™å®š 5 åˆ†é’Ÿå†…çš„æ•°æ®ï¼Œè¿”å›çš„æ˜¯èŒƒå›´å‘é‡</p>
</li>
<li>
<p>æŸ¥è¯¢æ¡ä»¶æ”¯æŒä¸ç­‰äº<code>!=</code>ï¼Œæ­£åˆ™ <code>=~</code> <code>!~</code>, ä¾‹å¦‚</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">http_requests_total<span style="color:#f92672">{</span>code!<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span><span style="color:#f92672">}</span>  // è¡¨ç¤ºæŸ¥è¯¢ code ä¸ä¸º <span style="color:#e6db74">&#34;200&#34;</span> çš„æ•°æ®
http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span>ï½<span style="color:#e6db74">&#34;2..&#34;</span><span style="color:#f92672">}</span> // è¡¨ç¤ºæŸ¥è¯¢ code ä¸º <span style="color:#e6db74">&#34;2xx&#34;</span> çš„æ•°æ®
http_requests_total<span style="color:#f92672">{</span>code!ï½<span style="color:#e6db74">&#34;2..&#34;</span><span style="color:#f92672">}</span> // è¡¨ç¤ºæŸ¥è¯¢ code ä¸ä¸º <span style="color:#e6db74">&#34;2xx&#34;</span> çš„æ•°æ®
</code></pre></div><ul>
<li>ç¬æ—¶å‘é‡ç»“æœæ”¯æŒ<a href="https://prometheus.io/docs/prometheus/latest/querying/operators/" target="_blank" rel="noopener">è¿ç®—</a>ï¼Œ<code>+ï¼Œ-ï¼Œ*ï¼Œ/ï¼Œ%ï¼Œ^ï¼Œ==ï¼Œ!=ï¼Œ&gt;ï¼Œ&lt;ï¼Œ&gt;=ï¼Œ&lt;=ï¼Œandï¼Œorï¼Œunlessï¼Œsumï¼Œminï¼Œmaxï¼Œavgï¼Œstddevï¼Œstdvarï¼Œcountï¼Œcount_valuesï¼Œbottomkï¼Œtopkï¼Œquantile</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span><span style="color:#f92672">}</span> * <span style="color:#ae81ff">2</span> // æŠŠé‡Œé¢çš„å€¼ * <span style="color:#ae81ff">2</span>
http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span><span style="color:#f92672">}</span> &gt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> // åªè¦å€¼ &gt; <span style="color:#ae81ff">2</span> çš„æ•°æ®
http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span><span style="color:#f92672">}</span> &gt;<span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> or http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span><span style="color:#f92672">}</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> // åªè¦å€¼ &gt; <span style="color:#ae81ff">2</span> çš„æ•°æ®å’Œå€¼ä¸º <span style="color:#ae81ff">0</span> çš„
sum<span style="color:#f92672">(</span>http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span><span style="color:#f92672">})</span> // å„ä¸ªæ—¶åºæ•°æ®é‡Œçš„å€¼æ±‚å’Œ
topk<span style="color:#f92672">(</span>5, http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span><span style="color:#f92672">})</span> // åªè¦å€¼åœ¨å‰ <span style="color:#ae81ff">5</span> çš„æ—¶åºæ•°æ®
</code></pre></div><ul>
<li><a href="https://prometheus.io/docs/prometheus/latest/querying/functions/" target="_blank" rel="noopener">å†…ç½®å‡½æ•° </a> å¦‚ <code>abs,floor, rate</code>, ä¸åŒå‡½æ•°æœ‰ç€ä¸åŒçš„æ“ä½œå¯¹è±¡ï¼Œä¾‹å¦‚ <code>rate</code> é’ˆå¯¹ä¸èŒƒå›´å‘é‡ï¼Œç¬æ—¶å‘é‡æ²¡æœ‰å¢é•¿ç‡</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">floor<span style="color:#f92672">(</span>avg<span style="color:#f92672">(</span>http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span><span style="color:#f92672">}))</span>	// å‘ä¸‹å–æ•´
ceil<span style="color:#f92672">(</span>avg<span style="color:#f92672">(</span>http_requests_total<span style="color:#f92672">{</span>code<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span><span style="color:#f92672">}))</span>	// å‘ä¸Šå–æ•´
rate<span style="color:#f92672">(</span>http_requests_total<span style="color:#f92672">[</span>5m<span style="color:#f92672">])</span>								// æ±‚ 5m å¢é•¿ç‡
</code></pre></div><h2 id="go-client-å®ç°è‡ªå®šä¹‰-exporter">Go Client å®ç°è‡ªå®šä¹‰ exporter <a href="#go-client-%e5%ae%9e%e7%8e%b0%e8%87%aa%e5%ae%9a%e4%b9%89-exporter" class="anchor">ğŸ”—</a></h2><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæåˆ°äº† Prometheus æä¾›äº†è®¸å¤šæ’ä»¶å¼çš„ <a href="https://prometheus.io/docs/instrumenting/exporters/" target="_blank" rel="noopener">Exporter</a>, å¯ä»¥é€šè¿‡å®‰è£…è¿™äº› exporter æ¥ç›‘æ§å„ç§æŒ‡æ ‡ï¼Œå¦‚æœºå™¨ã€å®¹å™¨ã€ä¸­é—´ä»¶ã€MySQL &hellip;</p>
<p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³ç›‘æ§åº”ç”¨ç¨‹åºå‘¢ï¼Œå¦‚ httpï¼Œrpc æ¥å£çš„ QPSã€æ¥å£æ—¶å»¶ã€é”™è¯¯ç‡ã€‚è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Prometheus Client SDK è‡ªå®šä¹‰ç›‘æ§</p>
<h3 id="ç¤ºä¾‹">ç¤ºä¾‹ <a href="#%e7%a4%ba%e4%be%8b" class="anchor">ğŸ”—</a></h3><ul>
<li>å¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼Œæœ‰ä¸€ä¸ª web çš„ demoï¼Œåˆ†åˆ«æœ‰ä¸¤ä¸ªæ¥å£ <code>/api1</code> ä¸ <code>api2</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
  <span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net/http&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/api1&#34;</span>, <span style="color:#a6e22e">api1</span>)
	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/api2&#34;</span>, <span style="color:#a6e22e">api2</span>)

	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:1234&#34;</span>, <span style="color:#66d9ef">nil</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">api1</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hello api1&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">api2</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hello api2&#34;</span>)
}

</code></pre></div><ul>
<li>å¦‚ä½•åˆ©ç”¨ prometheus ç›‘æ§è¿™ä¸¤ä¸ªæ¥å£è¯·æ±‚é‡ä¸æ¥å£æ—¶å»¶å‘¢</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">go get github.com/prometheus/client_golang/prometheus
</code></pre></div><ol>
<li>å‘å¤–æš´éœ² exporter åœ°å€ï¼Œä¸‹è¿°ä¾‹å­ä½¿ç”¨é»˜è®¤çš„ exporter æä¾›äº†ä¸€äº› go ç¨‹åºçš„åŸºæœ¬ç›‘æ§ï¼Œå¦‚ go åç¨‹æ•°ï¼Œåƒåœ¾å›æ”¶æ—¶é—´..</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#e6db74">&#34;/metrics&#34;</span>, <span style="color:#a6e22e">promhttp</span>.<span style="color:#a6e22e">Handler</span>())
<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:1235&#34;</span>, <span style="color:#66d9ef">nil</span>)
}()
</code></pre></div><p>exporter ä¸ŠæŠ¥æ•°æ®ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># HELP go_goroutines Number of goroutines that currently exist.</span>
<span style="color:#75715e"># TYPE go_goroutines gauge</span>
go_goroutines <span style="color:#ae81ff">9</span>
<span style="color:#75715e"># HELP go_info Information about the Go environment.</span>
<span style="color:#75715e"># TYPE go_info gauge</span>
go_info<span style="color:#f92672">{</span>version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;go1.17.2&#34;</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">1</span>
...
</code></pre></div><ol start="2">
<li>
<p>æ³¨å†Œè‡ªå®šä¹‰æ¥å£ Counter</p>
<ul>
<li>
<p><code>NewCounter</code>:ä¸€ä¸ª Counter</p>
</li>
<li>
<p><code>NewCounterVec</code>: ä¸€ç»„ Counterï¼ŒæŒ‰é‡Œé¢çš„ label å€¼åˆ†ç»„</p>
</li>
</ul>
</li>
</ol>
<p>ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼ˆå®Œæ•´ä¾‹å­åœ¨è¿™èŠ‚æœ€åï¼‰</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// å£°æ˜ä¸€ä¸ª Counter
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">apiCounterVec</span> = <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">NewCounterVec</span>(<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">CounterOpts</span>{
	<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;http_api_counter&#34;</span>,
	<span style="color:#a6e22e">Help</span>: <span style="color:#e6db74">&#34;web http requests number&#34;</span>,
}, []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;handler&#34;</span>})

<span style="color:#75715e">// å£°æ˜ ä¸€ç»„ Counter
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">apiTotalCounter</span> = <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">NewCounter</span>(<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">CounterOpts</span>{
	<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;http_api_total_counter&#34;</span>,
	<span style="color:#a6e22e">Help</span>: <span style="color:#e6db74">&#34;web http requests number&#34;</span>,
})
<span style="color:#75715e">// æ³¨å†Œåˆ° prometheus exporter ä¸­
</span><span style="color:#75715e"></span><span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">MustRegister</span>(<span style="color:#a6e22e">apiTotalCounter</span>)
<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">MustRegister</span>(<span style="color:#a6e22e">apiCounterVec</span>)

<span style="color:#75715e">// è®¡æ•°
</span><span style="color:#75715e"></span><span style="color:#a6e22e">apiTotalCounter</span>.<span style="color:#a6e22e">Inc</span>()
<span style="color:#a6e22e">apiCounterVec</span>.<span style="color:#a6e22e">WithLabelValues</span>(<span style="color:#e6db74">&#34;/api&#34;</span>).<span style="color:#a6e22e">Inc</span>()
</code></pre></div><ol start="3">
<li>æ³¨å†Œè‡ªå®šä¹‰æ¥å£ Histogram, ç¤ºä¾‹å¦‚ä¸‹</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// å£°æ˜ä¸€ç»„ Histogram
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">apiHandleMS</span> = <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">NewHistogramVec</span>(<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">HistogramOpts</span>{
	<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;http_api_handler_ms&#34;</span>,
	<span style="color:#a6e22e">Help</span>: <span style="color:#e6db74">&#34;Microseconds of HTTP interface processing&#34;</span>,
	<span style="color:#a6e22e">Buckets</span>: <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">LinearBuckets</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">19</span>,<span style="color:#ae81ff">10</span>),
}, []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;handler&#34;</span>})
<span style="color:#75715e">// æ³¨å†Œåˆ° prometheus exporter ç§ 
</span><span style="color:#75715e"></span><span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">MustRegister</span>(<span style="color:#a6e22e">apiHandleMS</span>)
<span style="color:#75715e">// è®¡æ•°
</span><span style="color:#75715e"></span><span style="color:#a6e22e">apiHandleMS</span>.<span style="color:#a6e22e">WithLabelValues</span>(<span style="color:#e6db74">&#34;/api&#34;</span>).<span style="color:#a6e22e">Observe</span>(<span style="color:#a6e22e">xx</span>)
</code></pre></div><ul>
<li><a href="https://github.com/he2121/demos/tree/master/prometheus" target="_blank" rel="noopener">å®Œæ•´ç¤ºä¾‹ä»“åº“</a>, å¤§è‡´æµç¨‹å¦‚ä¸‹</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">// åˆå§‹åŒ– prometheus exporter
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">initPrometheus</span>()

	<span style="color:#75715e">// web ç¤ºä¾‹
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/api1&#34;</span>, <span style="color:#a6e22e">prometheusMetric</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#a6e22e">api1</span>)))
	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/api2&#34;</span>, <span style="color:#a6e22e">prometheusMetric</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#a6e22e">api2</span>)))
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:1234&#34;</span>, <span style="color:#66d9ef">nil</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">initPrometheus</span>() {
	<span style="color:#75715e">// æ³¨å†Œè‡ªå®šä¹‰çš„ç›‘æ§æŒ‡æ ‡
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">MustRegister</span>(<span style="color:#a6e22e">apiTotalCounter</span>)
	<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">MustRegister</span>(<span style="color:#a6e22e">apiCounterVec</span>)
	<span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">MustRegister</span>(<span style="color:#a6e22e">apiHandleMS</span>)
	<span style="color:#75715e">// æš´éœ² exporter åœ°å€ï¼Œprometheus server é€šè¿‡ pull è¿™ä¸ªåœ°å€ï¼Œæ‹‰å–æŒ‡æ ‡æ•°æ®
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#e6db74">&#34;/metrics&#34;</span>, <span style="color:#a6e22e">promhttp</span>.<span style="color:#a6e22e">Handler</span>())
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:1235&#34;</span>, <span style="color:#66d9ef">nil</span>)
	}()
}

<span style="color:#75715e">// metric ä¸­é—´ä»¶
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">prometheusMetric</span>(<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
		<span style="color:#75715e">// æ€»æ¥å£è®¿é—®é‡è®¡æ•°
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">apiTotalCounter</span>.<span style="color:#a6e22e">Inc</span>()
		<span style="color:#75715e">// å•ä¸ªæ¥å£è®¿é—®é‡è®¡æ•°
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">apiCounterVec</span>.<span style="color:#a6e22e">WithLabelValues</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">String</span>()).<span style="color:#a6e22e">Inc</span>()
		<span style="color:#a6e22e">start</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
		<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>)
		<span style="color:#a6e22e">ms</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixMicro</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">start</span>.<span style="color:#a6e22e">UnixMicro</span>()
		<span style="color:#75715e">// æ¥å£æ—¶å»¶è®¡æ•°
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">apiHandleMS</span>.<span style="color:#a6e22e">WithLabelValues</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">String</span>()).<span style="color:#a6e22e">Observe</span>(float64(<span style="color:#a6e22e">ms</span>))
	}
}
</code></pre></div><p>è‡ªå®šä¹‰æŒ‡æ ‡ç»“æœï¼š</p>
<p><p class="markdown-image">
  <img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20211209111424017-2021-12-09.png" alt="image-20211209111424017"  />
</p></p>
<h2 id="æ€»ç»“">æ€»ç»“ <a href="#%e6%80%bb%e7%bb%93" class="anchor">ğŸ”—</a></h2><ul>
<li>ä»‹ç»äº† Prometheus å››ç§ Metric ç±»å‹</li>
<li>ä»‹ç»äº† PormQL ç®€å•ä½¿ç”¨</li>
<li>ä»¥ä¸€ä¸ªå®é™…ä¾‹å­ä»‹ç»äº†å¦‚ä½•ç”¨ Prometheus æä¾›çš„ client SDK è‡ªå®šä¹‰ç›‘æ§</li>
</ul>

    </div>

    
        <div class="tags">
            
                <a href="https://he2121.github.io/xiaohe-blog/tags/prometheus">prometheus</a>
            
                <a href="https://he2121.github.io/xiaohe-blog/tags/cloud-native">cloud native</a>
            
                <a href="https://he2121.github.io/xiaohe-blog/tags/%E7%9B%91%E6%8E%A7">ç›‘æ§</a>
            
        </div>
    
    
    

</section>

<script src="https://utteranc.es/client.js"
        repo="he2121/xiaohe-blog"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/he2121/" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>


</div>

    

    <div class="copyright">
    
       Â© Copyright 
       2021 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       å°è´º
    
    </div>

    
</footer>



  </body>
</html>
